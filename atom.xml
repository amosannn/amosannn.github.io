<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Amosannn</title>
  <subtitle>Amo&#39;s binary space</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://amosannn.github.io/"/>
  <updated>2019-05-16T02:33:47.001Z</updated>
  <id>https://amosannn.github.io/</id>
  
  <author>
    <name>Amosannn</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Haproxy 之 Http 代理的两种方式</title>
    <link href="https://amosannn.github.io/2019/04/30/haproxy-listen-vs-frontend/"/>
    <id>https://amosannn.github.io/2019/04/30/haproxy-listen-vs-frontend/</id>
    <published>2019-04-30T01:55:30.000Z</published>
    <updated>2019-05-16T02:33:47.001Z</updated>
    
    <content type="html"><![CDATA[<h2 id="listen-与-frontend-backend-的配置区别"><a href="#listen-与-frontend-backend-的配置区别" class="headerlink" title="listen 与 (frontend + backend) 的配置区别"></a>listen 与 (frontend + backend) 的配置区别</h2><h3 id="frontend-backend-的配置示例及运行流程"><a href="#frontend-backend-的配置示例及运行流程" class="headerlink" title="frontend + backend 的配置示例及运行流程"></a>frontend + backend 的配置示例及运行流程</h3><p>这是一个 HTTP 代理在所有接口上监听端口 80 的简单配置，请求进入后的运行流程如下：</p>
<ol>
<li><code>frontend</code> 监听 80 端口</li>
<li>请求被 <code>frontend</code> 转发到 <code>backend</code> 的 servers 中</li>
<li>请求进入运行在 127.0.0.1:8000 的 server1 中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># Simple configuration for an HTTP proxy listening on port 80 on all</div><div class="line"># interfaces and forwarding requests to a single backend &quot;servers&quot; with a</div><div class="line"># single server &quot;server1&quot; listening on 127.0.0.1:8000</div><div class="line"></div><div class="line">global</div><div class="line">daemon</div><div class="line">maxconn 256</div><div class="line"></div><div class="line">defaults</div><div class="line">mode http</div><div class="line">timeout connect 5000ms</div><div class="line">timeout client 50000ms</div><div class="line">timeout server 50000ms</div><div class="line"></div><div class="line">frontend http-in</div><div class="line">bind *:80</div><div class="line">default_backend servers</div><div class="line"></div><div class="line">backend servers</div><div class="line">server server1 127.0.0.1:8000 maxconn 32</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="listen-的配置示例及运行流程"><a href="#listen-的配置示例及运行流程" class="headerlink" title="listen 的配置示例及运行流程"></a>listen 的配置示例及运行流程</h3><p>使用单个 <code>listen</code> 块定义的相同配置。更精简但不那么富有表现力，尤其是在HTTP模式下。</p>
<ol>
<li>请求进入 80 端口</li>
<li>转发入运行在 127.0.0.1:8000 的 server1 中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># The same configuration defined with a single listen block. Shorter but</div><div class="line"># less expressive, especially in HTTP mode.</div><div class="line"></div><div class="line">global</div><div class="line">daemon</div><div class="line">maxconn 256</div><div class="line"></div><div class="line">defaults</div><div class="line">mode http</div><div class="line">timeout connect 5000ms</div><div class="line">timeout client 50000ms</div><div class="line">timeout server 50000ms</div><div class="line"></div><div class="line">listen http-in</div><div class="line">bind *:80</div><div class="line">server server1 127.0.0.1:8000 maxconn 32</div></pre></td></tr></table></figure>
<h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 修改配置并重启</div><div class="line">sudo vi /etc/haproxy/haproxy.cfg</div><div class="line">haproxy -c -f /etc/haproxy/haproxy.cfg</div><div class="line">sudo service haproxy restart</div><div class="line"></div><div class="line"># 设置权重</div><div class="line">echo &apos;set weight read_only-back/slave1 0&apos; | sudo socat stdio /run/haproxy/admin.sock</div><div class="line"></div><div class="line">echo &apos;set server read_only-back/slave1 agent up&apos; | sudo socat stdio /run/haproxy/admin.sock</div></pre></td></tr></table></figure>
<hr>
<h2 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h2><p><a href="http://cbonte.github.io/haproxy-dconv/" target="_blank" rel="external">HAProxy 各版本官方文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;listen-与-frontend-backend-的配置区别&quot;&gt;&lt;a href=&quot;#listen-与-frontend-backend-的配置区别&quot; class=&quot;headerlink&quot; title=&quot;listen 与 (frontend + backend) 的配置区别&quot;&gt;&lt;/a&gt;listen 与 (frontend + backend) 的配置区别&lt;/h2&gt;&lt;h3 id=&quot;frontend-backend-的配置示例及运行流程&quot;&gt;&lt;a href=&quot;#frontend-backend-的配置示例及运行流程&quot; class=&quot;headerlink&quot; title=&quot;frontend + backend 的配置示例及运行流程&quot;&gt;&lt;/a&gt;frontend + backend 的配置示例及运行流程&lt;/h3&gt;&lt;p&gt;这是一个 HTTP 代理在所有接口上监听端口 80 的简单配置，请求进入后的运行流程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;frontend&lt;/code&gt; 监听 80 端口&lt;/li&gt;
&lt;li&gt;请求被 &lt;code&gt;frontend&lt;/code&gt; 转发到 &lt;code&gt;backend&lt;/code&gt; 的 servers 中&lt;/li&gt;
&lt;li&gt;请求进入运行在 127.0.0.1:8000 的 server1 中&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# Simple configuration for an HTTP proxy listening on port 80 on all&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# interfaces and forwarding requests to a single backend &amp;quot;servers&amp;quot; with a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# single server &amp;quot;server1&amp;quot; listening on 127.0.0.1:8000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;global&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemon&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;maxconn 256&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;defaults&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mode http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;timeout connect 5000ms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;timeout client 50000ms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;timeout server 50000ms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;frontend http-in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bind *:80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default_backend servers&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;backend servers&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;server server1 127.0.0.1:8000 maxconn 32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Haproxy" scheme="https://amosannn.github.io/tags/Haproxy/"/>
    
  </entry>
  
  <entry>
    <title>Haproxy 之常用配置详解</title>
    <link href="https://amosannn.github.io/2019/04/28/haproxy-common-configuration-analysis/"/>
    <id>https://amosannn.github.io/2019/04/28/haproxy-common-configuration-analysis/</id>
    <published>2019-04-28T01:55:30.000Z</published>
    <updated>2019-05-16T02:34:48.194Z</updated>
    
    <content type="html"><![CDATA[<p>HAProxy 配置中有三个重要部分</p>
<ul>
<li>global</li>
<li>defaults</li>
<li>listen or (frontend + backend)</li>
</ul>
<h2 id="常用配置详解"><a href="#常用配置详解" class="headerlink" title="常用配置详解"></a>常用配置详解</h2><h3 id="全局配置（global）"><a href="#全局配置（global）" class="headerlink" title="全局配置（global）"></a>全局配置（global）</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>值</th>
<th>参数含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>maxconn</td>
<td>20480</td>
<td>默认最大连接数</td>
</tr>
<tr>
<td>daemon</td>
<td></td>
<td>以后台形式运行haproxy</td>
</tr>
<tr>
<td>nbproc</td>
<td>1</td>
<td>进程数量（可以设置多个进程提高性能）</td>
</tr>
<tr>
<td>pidfile</td>
<td>/var/run/haproxy.pid</td>
<td>haproxy 的 pid 存放路径，启动进程的用户必须有权限访问此文件</td>
</tr>
</tbody>
</table>
<h3 id="默认全局配置（defaults）"><a href="#默认全局配置（defaults）" class="headerlink" title="默认全局配置（defaults）"></a>默认全局配置（defaults）</h3><p>这些参数可以被利用配置到frontend，backend，listen组件</p>
<p>option 参数可以同时配置多个</p>
<p>balance 只可配置一个*</p>
<a id="more"></a>
<table>
<thead>
<tr>
<th>参数名</th>
<th>值</th>
<th>参数含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>log</td>
<td>global</td>
<td></td>
</tr>
<tr>
<td>mode</td>
<td>http</td>
<td>所处理的类别 (#七层:http;四层:tcp )</td>
</tr>
<tr>
<td>maxconn</td>
<td>20480</td>
<td>最大连接数</td>
</tr>
<tr>
<td>option</td>
<td>httplog</td>
<td>日志类别为 http 日志格式</td>
</tr>
<tr>
<td>option</td>
<td>httpclose</td>
<td>每次请求完毕后主动关闭 http 通道</td>
</tr>
<tr>
<td>option</td>
<td>dontlognull</td>
<td>不记录健康检查的日志信息</td>
</tr>
<tr>
<td>option</td>
<td>forwardfor</td>
<td>记录客户端 IP 在 X-Forwarded-For 头域中，用以获取客户端真实 ip</td>
</tr>
<tr>
<td>option</td>
<td>redispatch</td>
<td>serverId 对应的服务器挂掉后，强制定向到其他健康的服务器</td>
</tr>
<tr>
<td>option</td>
<td>abortonclose</td>
<td>当服务器负载很高的时候，自动结束掉当前队列处理比较久的连接</td>
</tr>
<tr>
<td>stats refresh</td>
<td>30</td>
<td>统计页面刷新间隔</td>
</tr>
<tr>
<td>retries</td>
<td>3</td>
<td>3次连接失败就认为服务不可用，也可以通过后面设置</td>
</tr>
<tr>
<td>balance</td>
<td>roundrobin</td>
<td>默认的负载均衡的方式，轮询方式</td>
</tr>
<tr>
<td>balance</td>
<td>source</td>
<td>默认的负载均衡的方式，类似 nginx 的 ip_hash</td>
</tr>
<tr>
<td>balance</td>
<td>leastconn</td>
<td>默认的负载均衡的方式，最小连接</td>
</tr>
<tr>
<td>timeout connect</td>
<td>5000ms</td>
<td>连接 server 端超时 5s</td>
</tr>
<tr>
<td>timeout client</td>
<td>50000ms</td>
<td>客户端响应超时 50s</td>
</tr>
<tr>
<td>timeout server</td>
<td>50000ms</td>
<td>server 端响应超时 50s</td>
</tr>
<tr>
<td>timeout check</td>
<td>2000</td>
<td>心跳检测超时时间</td>
</tr>
</tbody>
</table>
<h3 id="监控页面的设置"><a href="#监控页面的设置" class="headerlink" title="监控页面的设置"></a>监控页面的设置</h3><h4 id="listen-的配置参数"><a href="#listen-的配置参数" class="headerlink" title="listen 的配置参数"></a>listen 的配置参数</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>值</th>
<th>参数含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>listen</td>
<td>listen_demo</td>
<td>监控组名称，是 Frontend 和 Backend 的组合体</td>
</tr>
<tr>
<td>bind</td>
<td>0.0.0.0:65532</td>
<td>供外部访问的地址及端口</td>
</tr>
<tr>
<td>mode</td>
<td>http</td>
<td>代理模式</td>
</tr>
<tr>
<td>log</td>
<td>127.0.0.1 local3 err</td>
<td>错误日志记录</td>
</tr>
</tbody>
</table>
<p>HTTP 模式的相关设置</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>值</th>
<th>参数含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>stats refresh</td>
<td>5s</td>
<td>监控页自动刷新时间</td>
</tr>
<tr>
<td>stats uri</td>
<td>/admin?stats</td>
<td>监控页的地址</td>
</tr>
<tr>
<td>stats realm</td>
<td>/info</td>
<td>监控面的提示信息</td>
</tr>
<tr>
<td>stats auth</td>
<td>admin:admin</td>
<td>监控页鉴权，可以同时设置多个用户</td>
</tr>
<tr>
<td>stats</td>
<td>hide-version</td>
<td>隐藏统计页面上的 HAproxy 版本信息</td>
</tr>
<tr>
<td>errorfile 403</td>
<td>/etc/haproxy/errorfiles/403.http</td>
<td></td>
</tr>
<tr>
<td>errorfile 500</td>
<td>/etc/haproxy/errorfiles/500.http</td>
<td></td>
</tr>
<tr>
<td>errorfile 502</td>
<td>/etc/haproxy/errorfiles/502.http</td>
<td></td>
</tr>
<tr>
<td>errorfile 503</td>
<td>/etc/haproxy/errorfiles/503.http</td>
<td></td>
</tr>
<tr>
<td>errorfile 504</td>
<td>/etc/haproxy/errorfiles/504.http</td>
</tr>
</tbody>
</table>
<h4 id="frontend-的配置参数"><a href="#frontend-的配置参数" class="headerlink" title="frontend 的配置参数"></a>frontend 的配置参数</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>值</th>
<th>参数含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>frontend</td>
<td>frontend_name</td>
<td></td>
</tr>
<tr>
<td>bind</td>
<td>0.0.0.0:1080</td>
<td>供外部访问的地址及端口</td>
</tr>
<tr>
<td>mode</td>
<td>http</td>
<td></td>
</tr>
<tr>
<td>log</td>
<td>global</td>
<td>应用全局的日志配置</td>
</tr>
<tr>
<td>option</td>
<td>httplog</td>
<td>启用 http 的 log</td>
</tr>
<tr>
<td>option</td>
<td>httpclose</td>
<td>每次请求完毕后主动关闭 http 通道，<code>HA-Proxy</code> 不支持 keep-alive 模式</td>
</tr>
<tr>
<td>option</td>
<td>forwardfor</td>
<td>如果后端服务器需要获得客户端的真实 IP 需要配置次参数，将可以从 Http Header 中获得客户端 IP</td>
</tr>
<tr>
<td>default_backend</td>
<td>servers</td>
<td>请求转发至名为 <code>servers</code> 的后端服务</td>
</tr>
</tbody>
</table>
<h4 id="backend-的配置参数"><a href="#backend-的配置参数" class="headerlink" title="backend 的配置参数"></a>backend 的配置参数</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>值</th>
<th>参数含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>backend</td>
<td>servers</td>
<td>后端服务名，可自定义</td>
</tr>
<tr>
<td>mode</td>
<td>http</td>
<td></td>
</tr>
<tr>
<td>balance</td>
<td>roundrobin</td>
<td>负载均衡，轮询方式</td>
</tr>
<tr>
<td>option</td>
<td>httpchk GET /index.html</td>
<td>启动心跳检测的地址</td>
</tr>
<tr>
<td>server</td>
<td></td>
</tr>
</tbody>
</table>
<p>backend 中 server 的参数</p>
<ul>
<li>server web1 192.168.11.2:80 check inter 1500 rise 3 fall 3 weight 1</li>
</ul>
<table>
<thead>
<tr>
<th>参数名</th>
<th>值</th>
<th>参数含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>server</td>
<td>server1</td>
<td>server 名</td>
</tr>
<tr>
<td>check</td>
<td>inter 1500</td>
<td>心跳检测频率</td>
</tr>
<tr>
<td>rise</td>
<td>3</td>
<td>3 次正确认为服务器可用</td>
</tr>
<tr>
<td>fall</td>
<td>3</td>
<td>3 次失败认为服务器不可用</td>
</tr>
<tr>
<td>weight</td>
<td>2</td>
<td>代表权重如果检查失败会自动踢掉该服务器</td>
</tr>
</tbody>
</table>
<h2 id="配置自由的时间单位"><a href="#配置自由的时间单位" class="headerlink" title="配置自由的时间单位"></a>配置自由的时间单位</h2><p>一些参数涉及表示时间的值，例如超时。这些值通常以毫秒表示（除非有特殊说明），但可以通过改变后缀单位来改变这些值。</p>
<p>支持的单位是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- us : microseconds. 1 microsecond = 1/1000000 second</div><div class="line">- ms : milliseconds. 1 millisecond = 1/1000 second. This is the default.</div><div class="line">- s  : seconds. 1s = 1000ms</div><div class="line">- m  : minutes. 1m = 60s = 60000ms</div><div class="line">- h  : hours.   1h = 60m = 3600s = 3600000ms</div><div class="line">- d  : days.    1d = 24h = 1440m = 86400s = 86400000ms</div></pre></td></tr></table></figure>
<h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 修改配置并重启</div><div class="line">sudo vi /etc/haproxy/haproxy.cfg</div><div class="line">haproxy -c -f /etc/haproxy/haproxy.cfg</div><div class="line">sudo service haproxy restart</div><div class="line"></div><div class="line"># 设置权重</div><div class="line">echo &apos;set weight read_only-back/slave1 0&apos; | sudo socat stdio /run/haproxy/admin.sock</div><div class="line"></div><div class="line">echo &apos;set server read_only-back/slave1 agent up&apos; | sudo socat stdio /run/haproxy/admin.sock</div></pre></td></tr></table></figure>
<hr>
<h2 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h2><p><a href="http://cbonte.github.io/haproxy-dconv/" target="_blank" rel="external">HAProxy 各版本官方文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HAProxy 配置中有三个重要部分&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;global&lt;/li&gt;
&lt;li&gt;defaults&lt;/li&gt;
&lt;li&gt;listen or (frontend + backend)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;常用配置详解&quot;&gt;&lt;a href=&quot;#常用配置详解&quot; class=&quot;headerlink&quot; title=&quot;常用配置详解&quot;&gt;&lt;/a&gt;常用配置详解&lt;/h2&gt;&lt;h3 id=&quot;全局配置（global）&quot;&gt;&lt;a href=&quot;#全局配置（global）&quot; class=&quot;headerlink&quot; title=&quot;全局配置（global）&quot;&gt;&lt;/a&gt;全局配置（global）&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;参数名&lt;/th&gt;
&lt;th&gt;值&lt;/th&gt;
&lt;th&gt;参数含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;maxconn&lt;/td&gt;
&lt;td&gt;20480&lt;/td&gt;
&lt;td&gt;默认最大连接数&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;daemon&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;以后台形式运行haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;nbproc&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;进程数量（可以设置多个进程提高性能）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;pidfile&lt;/td&gt;
&lt;td&gt;/var/run/haproxy.pid&lt;/td&gt;
&lt;td&gt;haproxy 的 pid 存放路径，启动进程的用户必须有权限访问此文件&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;默认全局配置（defaults）&quot;&gt;&lt;a href=&quot;#默认全局配置（defaults）&quot; class=&quot;headerlink&quot; title=&quot;默认全局配置（defaults）&quot;&gt;&lt;/a&gt;默认全局配置（defaults）&lt;/h3&gt;&lt;p&gt;这些参数可以被利用配置到frontend，backend，listen组件&lt;/p&gt;
&lt;p&gt;option 参数可以同时配置多个&lt;/p&gt;
&lt;p&gt;balance 只可配置一个*&lt;/p&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Haproxy" scheme="https://amosannn.github.io/tags/Haproxy/"/>
    
  </entry>
  
  <entry>
    <title>Airflow 如何让用户只能看到自己创建的 Dag</title>
    <link href="https://amosannn.github.io/2018/12/24/airflow-create-user-and-filter-dags-by-owner/"/>
    <id>https://amosannn.github.io/2018/12/24/airflow-create-user-and-filter-dags-by-owner/</id>
    <published>2018-12-24T01:55:30.000Z</published>
    <updated>2018-12-29T03:32:22.328Z</updated>
    
    <content type="html"><![CDATA[<p>Airflow 是个很奇怪的东西，直到 1.10 它都没有权限系统，自带的创建用户和密码验证，只能作为一扇挡着外人的门。只要打开这扇门，里面的所有 <code>Owner</code> 下的 Dag 都会完完全全展示在你面前并且受你掌控。</p>
<p>究其原因，便是 airflow 自带的用户创建默认是 <code>superuser</code>，虽然话是这么说，创建个普通 user 就行了，但在一系列尝试后，我发现，它并没有提供其他等级的用户给你选择，只有 <code>superuser</code> 。。</p>
<p>所以在尝试了这一系列操作之后，我觉得有必要使用官方建议的 <code>LDAP</code>，虽然它看起来很麻烦的样子。</p>
<p>然而经过一番探查，我发现 <code>LDAP</code> 的作用并不是 filter dags by ower，他只是细粒度的分配登录权限。而真正的分发 Dag 到个人账户下，还是得等待 airflow 新版本的发布（当前版本该选项不生效）。</p>
<hr>
<p><a href="https://stackoverflow.com/questions/47205798/airflow-webserver-not-filtering-dags-by-owner" target="_blank" rel="external">airflow webserver not filtering dags by owner</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Airflow 是个很奇怪的东西，直到 1.10 它都没有权限系统，自带的创建用户和密码验证，只能作为一扇挡着外人的门。只要打开这扇门，里面的所有 &lt;code&gt;Owner&lt;/code&gt; 下的 Dag 都会完完全全展示在你面前并且受你掌控。&lt;/p&gt;
&lt;p&gt;究其原因，便是 ai
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Airflow" scheme="https://amosannn.github.io/tags/Airflow/"/>
    
      <category term="LDAP" scheme="https://amosannn.github.io/tags/LDAP/"/>
    
  </entry>
  
  <entry>
    <title>使用 Grafana + Graphite 进行数据预警监控</title>
    <link href="https://amosannn.github.io/2018/12/17/data-alert-by-graphite-and-grafana/"/>
    <id>https://amosannn.github.io/2018/12/17/data-alert-by-graphite-and-grafana/</id>
    <published>2018-12-17T01:55:25.000Z</published>
    <updated>2019-05-16T02:37:54.865Z</updated>
    
    <content type="html"><![CDATA[<p><img src="../images/grafana/DeepinScrot-2637.png" alt=""></p>
<h1 id="向-Graphite-写入数据"><a href="#向-Graphite-写入数据" class="headerlink" title="向 Graphite 写入数据"></a>向 Graphite 写入数据</h1><p>Graphite 的数据主要以 <code>whisper</code> 的格式存储在 <code>carbon</code> 这个组件中，而向其中填充数据的话我们有多种方式，这里演示两种常用手段。</p>
<h2 id="使用-python"><a href="#使用-python" class="headerlink" title="使用 python"></a>使用 python</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip3 install graphyte</div></pre></td></tr></table></figure>
<p>这里使用了 <code>graphyte</code>，用法很简单，只需要指定写入的 series 对应的值即可，写入的时间戳与 tag 是附加选项，可写可不写。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">graphyte.send(series, value, timestamp, &#123;<span class="string">'tag_name'</span>: tag_value, <span class="string">'tag_name'</span>: <span class="string">'tag_value'</span>&#125;)</div></pre></td></tr></table></figure>
<h2 id="使用-curl"><a href="#使用-curl" class="headerlink" title="使用 curl"></a>使用 curl</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ echo &quot;foo.bar 3 `date +%s`&quot; | nc 127.0.0.1 2003</div></pre></td></tr></table></figure>
<p>当数据准备好了之后便按你的喜好来设置图形的样式</p>
<h1 id="设置预警"><a href="#设置预警" class="headerlink" title="设置预警"></a>设置预警</h1><p>进入到 <code>Grafana</code> 中的 Alert 标签下，主要需要设置以下几个参数</p>
<ol>
<li>Alert Config</li>
<li>Conditions</li>
</ol>
<p>如果想在设置的阈值触发时发送消息通知，则需要进一步设置 <code>Notifications</code> 以及 <code>Alert Rules</code> 和 <code>Notification channels</code></p>
<h2 id="Alert-Config"><a href="#Alert-Config" class="headerlink" title="Alert Config"></a>Alert Config</h2><p>主要关注 <code>Evaluate every</code> 这个选项</p>
<p>我猜想 Grafana 的开发团队对它的定义为时效性高的预警通知工具，对于数据异常的及时发现，对比的间隔时间显然是越短越好。</p>
<p>它们希望你将比对的时间间隔缩短，30s、60s、120s，这样发现数据异常的速度也就越快。</p>
<p>今年年初，开发者在一条 issue 下做过这样一个答复</p>
<blockquote>
<p>torkelo: you cannot control what time of day it will evaluate, it will evaluate every 24 hours. So if it was more than 24 hours since last evaluation it will evaluate (no matter what time of day)</p>
</blockquote>
<p>所以，<strong>grafana 对小时级、天级或在精确时间点触发预警的支持是很不友好的</strong>。<br><a id="more"></a></p>
<p>例如，你想让你的数据在每个整点触发一次数据比对，至少在当前的最新版本(v5.4.2)，都是不支持的。</p>
<p>而在 <code>Evaluate every</code> 的配置下，你也<strong>无法保证它的执行时间</strong>。</p>
<p>举个栗子，你做了这样的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Evaluate every: 1h</div></pre></td></tr></table></figure>
<p>设置了 1h 的执行间隔，那<strong>当这次告警对比结束后，它会在下一个告警周期中的不确定时间开始新的告警对比</strong>。</p>
<p>也就是说，假设 Grafana 在 10:00 的时候执行了一次，你期待它下次执行时间为 11:00，然而现实是它会在 10:00 ~ 11:00 间的任意时间执行，提前执行。</p>
<p>如果你想到了，那就能早早更改策略，如果想不到，那也开心下，毕竟生活处处是惊喜。</p>
<h2 id="Conditions"><a href="#Conditions" class="headerlink" title="Conditions"></a>Conditions</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">avg() OF query(A, 15m, now) IS BELOW 14</div></pre></td></tr></table></figure>
<p>预警阈值主要就是在这里设置，解释下上面的表达式：</p>
<p>A 线的 15 分钟前至当前的平均值，如果小低于 14，则触发报警。</p>
<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><blockquote>
<p>我想计算当前与过去七天平均值的增减幅？</p>
</blockquote>
<p>思路是对过去七天的数据取平均值，再来与当前时间比对，但是由于 <code>Graphite</code> 并没有让 <code>series</code> 与常数做计算的函数，所以我们只能用另一种精妙的方式曲线救国。</p>
<p>计算增减幅的公式为：(当前 - 过去)/过去 =&gt; 当前/过去 - 1</p>
<p>所以我们只需要画一条当前与过去的比值，再在 <code>Conditions</code> 的阈值中设置预期值 + 1 即可</p>
<p>例如，我们想在增幅超过 50% 减幅超过 30% 时触发告警通知，那么使用 <code>asPercent</code> 函数便可计算出当前占用过去的比率，再在 <code>Conditions</code> 中进行这样的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">avg() OF query(C, 15m, now) IS OUTSIDE RANGE 70 to 150</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;../images/grafana/DeepinScrot-2637.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;向-Graphite-写入数据&quot;&gt;&lt;a href=&quot;#向-Graphite-写入数据&quot; class=&quot;headerlink&quot; title=&quot;向 Graphite 写入数据&quot;&gt;&lt;/a&gt;向 Graphite 写入数据&lt;/h1&gt;&lt;p&gt;Graphite 的数据主要以 &lt;code&gt;whisper&lt;/code&gt; 的格式存储在 &lt;code&gt;carbon&lt;/code&gt; 这个组件中，而向其中填充数据的话我们有多种方式，这里演示两种常用手段。&lt;/p&gt;
&lt;h2 id=&quot;使用-python&quot;&gt;&lt;a href=&quot;#使用-python&quot; class=&quot;headerlink&quot; title=&quot;使用 python&quot;&gt;&lt;/a&gt;使用 python&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ pip3 install graphyte&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里使用了 &lt;code&gt;graphyte&lt;/code&gt;，用法很简单，只需要指定写入的 series 对应的值即可，写入的时间戳与 tag 是附加选项，可写可不写。&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;graphyte.send(series, value, timestamp, &amp;#123;&lt;span class=&quot;string&quot;&gt;&#39;tag_name&#39;&lt;/span&gt;: tag_value, &lt;span class=&quot;string&quot;&gt;&#39;tag_name&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;tag_value&#39;&lt;/span&gt;&amp;#125;)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;使用-curl&quot;&gt;&lt;a href=&quot;#使用-curl&quot; class=&quot;headerlink&quot; title=&quot;使用 curl&quot;&gt;&lt;/a&gt;使用 curl&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ echo &amp;quot;foo.bar 3 `date +%s`&amp;quot; | nc 127.0.0.1 2003&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当数据准备好了之后便按你的喜好来设置图形的样式&lt;/p&gt;
&lt;h1 id=&quot;设置预警&quot;&gt;&lt;a href=&quot;#设置预警&quot; class=&quot;headerlink&quot; title=&quot;设置预警&quot;&gt;&lt;/a&gt;设置预警&lt;/h1&gt;&lt;p&gt;进入到 &lt;code&gt;Grafana&lt;/code&gt; 中的 Alert 标签下，主要需要设置以下几个参数&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Alert Config&lt;/li&gt;
&lt;li&gt;Conditions&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;如果想在设置的阈值触发时发送消息通知，则需要进一步设置 &lt;code&gt;Notifications&lt;/code&gt; 以及 &lt;code&gt;Alert Rules&lt;/code&gt; 和 &lt;code&gt;Notification channels&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;Alert-Config&quot;&gt;&lt;a href=&quot;#Alert-Config&quot; class=&quot;headerlink&quot; title=&quot;Alert Config&quot;&gt;&lt;/a&gt;Alert Config&lt;/h2&gt;&lt;p&gt;主要关注 &lt;code&gt;Evaluate every&lt;/code&gt; 这个选项&lt;/p&gt;
&lt;p&gt;我猜想 Grafana 的开发团队对它的定义为时效性高的预警通知工具，对于数据异常的及时发现，对比的间隔时间显然是越短越好。&lt;/p&gt;
&lt;p&gt;它们希望你将比对的时间间隔缩短，30s、60s、120s，这样发现数据异常的速度也就越快。&lt;/p&gt;
&lt;p&gt;今年年初，开发者在一条 issue 下做过这样一个答复&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;torkelo: you cannot control what time of day it will evaluate, it will evaluate every 24 hours. So if it was more than 24 hours since last evaluation it will evaluate (no matter what time of day)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;所以，&lt;strong&gt;grafana 对小时级、天级或在精确时间点触发预警的支持是很不友好的&lt;/strong&gt;。&lt;br&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Graphite" scheme="https://amosannn.github.io/tags/Graphite/"/>
    
      <category term="Grafana" scheme="https://amosannn.github.io/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>Graphite 之把它装起来</title>
    <link href="https://amosannn.github.io/2018/11/29/install-graphite/"/>
    <id>https://amosannn.github.io/2018/11/29/install-graphite/</id>
    <published>2018-11-29T08:41:17.000Z</published>
    <updated>2018-11-30T10:58:11.820Z</updated>
    
    <content type="html"><![CDATA[<p>Graphite 是一款时序数据库</p>
<h1 id="初步安装"><a href="#初步安装" class="headerlink" title="初步安装"></a>初步安装</h1><p>安装 <code>Graphite</code> 有 n 种方法，在下选用的是 <code>pip</code> 安装的方式，使用默认安装位置 <code>/opt/graphite</code></p>
<p>十分简单，只需要分别安装三个组件 <code>graphite-web</code> 、 <code>whisper</code> 、 <code>carbon</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ export PYTHONPATH=&quot;/opt/graphite/lib/:/opt/graphite/webapp/&quot;</div><div class="line">$ pip3 install --no-binary=:all: https://github.com/graphite-project/whisper/tarball/master</div><div class="line">$ pip3 install --no-binary=:all: https://github.com/graphite-project/carbon/tarball/master</div><div class="line">$ pip3 install --no-binary=:all: https://github.com/graphite-project/graphite-web/tarball/master</div></pre></td></tr></table></figure>
<p>如果你希望自己指定安装位置：<a href="https://graphite.readthedocs.io/en/latest/install-pip.html#" target="_blank" rel="external">Installing From Pip</a></p>
<a id="more"></a>
<h2 id="安装过程中可能出现的问题"><a href="#安装过程中可能出现的问题" class="headerlink" title="安装过程中可能出现的问题"></a>安装过程中可能出现的问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip3 install --no-binary=:all: https://github.com/graphite-project/graphite-web/tarball/master</div></pre></td></tr></table></figure>
<p>在执行第三条语句的时候</p>
<p>duang!!!</p>
<blockquote>
<p>distutils.errors.CompileError: command ‘x86_64-linux-gnu-gcc’ failed with exit status 1</p>
<p>……</p>
<p>distutils.errors.DistutilsError: Setup script exited with error: command ‘x86_64-linux-gnu-gcc’ failed with exit status 1</p>
</blockquote>
<p>执行下面语句方可药到病除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install libpq-dev python-dev libxml2-dev libxslt1-dev libldap2-dev libsasl2-dev libffi-dev</div></pre></td></tr></table></figure>
<h1 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h1><h2 id="修改-webapp-元数据库"><a href="#修改-webapp-元数据库" class="headerlink" title="修改 webapp 元数据库"></a>修改 webapp 元数据库</h2><p>Django 元数据默认存储在 SQLite 中，但为了更好的扩展性，在下把它放到 mysql 中</p>
<blockquote>
<p>If running multiple Graphite-web instances, a database such as PostgreSQL or MySQL is required so that all instances may share the same data source.</p>
</blockquote>
<h3 id="为-Graphite-添加数据库账号"><a href="#为-Graphite-添加数据库账号" class="headerlink" title="为 Graphite 添加数据库账号"></a>为 Graphite 添加数据库账号</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create database graphite;</div><div class="line">mysql&gt;  grant all on graphitedb.* to &apos;graphite&apos;@&apos;%&apos; identified by &apos;graphitepass&apos;;</div><div class="line">mysql&gt;  grant all on graphitedb.* to &apos;graphite&apos;@&apos;localhost&apos; identified by &apos;graphitepass&apos;;</div></pre></td></tr></table></figure>
<h3 id="添加（修改）database-配置"><a href="#添加（修改）database-配置" class="headerlink" title="添加（修改）database 配置"></a>添加（修改）database 配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cd /opt/graphite/webapp/graphite</div><div class="line">$ cp local_settings.py.example local_settings.py</div><div class="line">$ vi local_settings.py</div></pre></td></tr></table></figure>
<p>数据库配置的格式可参考 <a href="https://docs.djangoproject.com/en/dev/ref/settings/#databases" target="_blank" rel="external">django 文档</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">DATABASES = &#123;</div><div class="line">    &apos;default&apos;: &#123;</div><div class="line">        &apos;NAME&apos;: &apos;graphite&apos;,</div><div class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,</div><div class="line">        &apos;USER&apos;: &apos;graphite&apos;,</div><div class="line">        &apos;PASSWORD&apos;: &apos;graphitepass&apos;,</div><div class="line">        &apos;HOST&apos;: &apos;localhost&apos;,</div><div class="line">        &apos;PORT&apos;: &apos;3306&apos;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> 记得提前建库</p>
</blockquote>
<h3 id="重新初始化元数据"><a href="#重新初始化元数据" class="headerlink" title="重新初始化元数据"></a>重新初始化元数据</h3><p>修改了数据库配置之后，需要在 Mysql 中重新初始化元数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PYTHONPATH=$GRAPHITE_ROOT/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：需将 <code>$GRAPHITE_ROOT</code> 替换为你的安装位置，如果是默认安装则为 <code>/opt/graphite</code></p>
</blockquote>
<h2 id="开始配置-Webapp"><a href="#开始配置-Webapp" class="headerlink" title="开始配置 Webapp"></a>开始配置 Webapp</h2><p>为了让服务器达到高可用、高性能，我们选用 nginx + wsgi，官方提供了三种方案</p>
<ul>
<li>nginx + gunicorn</li>
<li>Apache + mod_wsgi</li>
<li>Nginx + uWSGI</li>
</ul>
<p>此处我们选用第一个方案 nginx + gunicorn</p>
<p>使用这套组合只是为了让 python 下的 web 服务更加健壮，nginx 负责负载均衡、缓存请求等功能，而 gunicorn 负责接收来自 nginx 的动态请求，处理后返回给 nginx，再由 nginx 返回给用户。</p>
<h3 id="安装-Gunicorn"><a href="#安装-Gunicorn" class="headerlink" title="安装 Gunicorn"></a>安装 Gunicorn</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip3 install gunicorn</div></pre></td></tr></table></figure>
<h3 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt install nginx</div></pre></td></tr></table></figure>
<h4 id="为-Graphite-配置特定的日志文件"><a href="#为-Graphite-配置特定的日志文件" class="headerlink" title="为 Graphite 配置特定的日志文件"></a>为 Graphite 配置特定的日志文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo touch /var/log/nginx/graphite.access.log</div><div class="line">$ sudo touch /var/log/nginx/graphite.error.log</div><div class="line">$ sudo chmod 640 /var/log/nginx/graphite.*</div><div class="line">$ sudo chown user:user /var/log/nginx/graphite.*</div></pre></td></tr></table></figure>
<h4 id="定制-Graphite-配置文件"><a href="#定制-Graphite-配置文件" class="headerlink" title="定制 Graphite 配置文件"></a>定制 Graphite 配置文件</h4><blockquote>
<p>vi /etc/nginx/sites-available/graphite</p>
</blockquote>
<p>内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">upstream graphite &#123;</div><div class="line">    server 127.0.0.1:8080 fail_timeout=0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line"></div><div class="line">    server_name 127.0.0.1;</div><div class="line"></div><div class="line">    root /opt/graphite/webapp;</div><div class="line"></div><div class="line">    access_log /var/log/nginx/graphite.access.log;</div><div class="line">    error_log  /var/log/nginx/graphite.error.log;</div><div class="line"></div><div class="line">    location = /favicon.ico &#123;</div><div class="line">        return 204;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location /static/ &#123;</div><div class="line">        alias /opt/graphite/static/;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        try_files $uri @graphite;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location @graphite &#123;</div><div class="line">        proxy_pass_header Server;</div><div class="line">        proxy_set_header Host $http_host;</div><div class="line">        proxy_redirect off;</div><div class="line">        proxy_set_header X-Real-IP $remote_addr;</div><div class="line">        proxy_set_header X-Scheme $scheme;</div><div class="line">        proxy_connect_timeout 10;</div><div class="line">        proxy_read_timeout 10;</div><div class="line">        proxy_pass http://graphite;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>部分配置需要按部署策略修改，例如 <code>server_name</code> 、<code>root</code> 等</p>
<h4 id="启用配置文件"><a href="#启用配置文件" class="headerlink" title="启用配置文件"></a>启用配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo ln -s /etc/nginx/sites-available/graphite /etc/nginx/sites-enabled</div><div class="line">$ sudo rm -f /etc/nginx/sites-enabled/default</div><div class="line"></div><div class="line">$ sudo service nginx reload</div></pre></td></tr></table></figure>
<h1 id="启动-Graphite"><a href="#启动-Graphite" class="headerlink" title="启动 Graphite"></a>启动 Graphite</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ PYTHONPATH=/opt/graphite/webapp gunicorn wsgi --workers=4 --bind=127.0.0.1:8080 --log-file=/var/log/gunicorn.log --preload --pythonpath=/opt/graphite/webapp/graphite &amp;</div></pre></td></tr></table></figure>
<p>上面的命令会让 graphite 启动在 <code>localhost:8080</code> ，记录日志在 <code>/var/log/gunicorn.log</code> ，并且使用 <code>/opt/graphite/webapp/graphite</code> 座位 webapp 的路径。</p>
<p>由于我们已经在 nginx 中绑定了 8080 端口，所以进入这个地址就 ok 了：<a href="127.0.0.1">127.0.0.1</a></p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="修改-Graphite-时区"><a href="#修改-Graphite-时区" class="headerlink" title="修改 Graphite 时区"></a>修改 Graphite 时区</h2><p>如果你需要将时区切到北京时间来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ vi /opt/graphite/webapp/graphite/local_settings.py</div><div class="line"></div><div class="line">TIME_ZONE = &apos;Asia/Shanghai&apos;</div></pre></td></tr></table></figure>
<h2 id="配置过程中可能出现的问题"><a href="#配置过程中可能出现的问题" class="headerlink" title="配置过程中可能出现的问题"></a>配置过程中可能出现的问题</h2><h3 id="django-core-exceptions-ImproperlyConfigured-Error-loading-MySQLdb-module"><a href="#django-core-exceptions-ImproperlyConfigured-Error-loading-MySQLdb-module" class="headerlink" title="django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module."></a>django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module.</h3><p>给python3 装上MySQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip3 install mysqlclient</div></pre></td></tr></table></figure>
<p>小声 bb：mysqlclient 查询比 pymysql 快</p>
<h3 id="进入-graphite-web-界面却看见一片空白"><a href="#进入-graphite-web-界面却看见一片空白" class="headerlink" title="进入 graphite web 界面却看见一片空白"></a>进入 graphite web 界面却看见一片空白</h3><p>两种情况</p>
<h4 id="没有找到-static-目录"><a href="#没有找到-static-目录" class="headerlink" title="没有找到 static 目录"></a>没有找到 static 目录</h4><p>注意观察控制台（后台运行则看输出的日志），是否输出类似信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Not Found: /static/img/graphite-logo.png</div><div class="line">Not Found: /static/js/ext/adapter/ext/ext-base-debug.js</div><div class="line">Not Found: /static/js/ext/resources/css/ext-all.css</div><div class="line">Not Found: /static/js/browser.js</div><div class="line">Not Found: /static/js/ext/ext-all-debug.js</div><div class="line">Not Found: /static/js/composer_widgets.js</div><div class="line">Not Found: /static/js/composer.js</div><div class="line">Not Found: /static/js/completer.js</div><div class="line">Not Found: /static/img/carbon-fiber.png</div><div class="line">Not Found: /static/js/browser.js</div><div class="line">Not Found: /static/js/composer_widgets.js</div><div class="line">Not Found: /static/js/composer.js</div><div class="line">Not Found: /static/js/completer.js</div></pre></td></tr></table></figure>
<p>如果是，则为寻找不到静态文件</p>
<p>执行下面的命令，注意替换 <code>$GRAPHITE_ROOT</code> 为 graphite 的目录，默认为 <code>/opt/graphite</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ PYTHONPATH=$GRAPHITE_ROOT/webapp django-admin.py collectstatic --noinput --settings=graphite.settings</div></pre></td></tr></table></figure>
<p>然后在编辑 nginx 配置，并增加如下配置</p>
<blockquote>
<p>vi /etc/nginx/sites-available/graphite</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /static/ &#123;</div><div class="line">    alias /opt/graphite/static/;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：上面的修改只有在 nginx 的转发下才可寻找到 static 目录，若不想通过 nginx 访问，参阅下面的文档</p>
</blockquote>
<p>关于 static 目录，官方文档给出了解释：<a href="https://graphite.readthedocs.io/en/latest/config-local-settings.html#filesystem-paths" target="_blank" rel="external">Filesystem Paths</a></p>
<h4 id="试试打开-debug-模式"><a href="#试试打开-debug-模式" class="headerlink" title="试试打开 debug 模式"></a>试试打开 debug 模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ cd /opt/graphite/webapp/graphite</div><div class="line">$ vi local_settings.py</div><div class="line"></div><div class="line"># 将 DEBUG 设为 True</div><div class="line">DEBUG = True</div></pre></td></tr></table></figure>
<p>不明白为啥的同学，可以参考这个 issue：<a href="https://github.com/graphite-project/graphite-web/issues/858" target="_blank" rel="external">Static Folder Cannot Found</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Graphite 是一款时序数据库&lt;/p&gt;
&lt;h1 id=&quot;初步安装&quot;&gt;&lt;a href=&quot;#初步安装&quot; class=&quot;headerlink&quot; title=&quot;初步安装&quot;&gt;&lt;/a&gt;初步安装&lt;/h1&gt;&lt;p&gt;安装 &lt;code&gt;Graphite&lt;/code&gt; 有 n 种方法，在下选用的是 &lt;code&gt;pip&lt;/code&gt; 安装的方式，使用默认安装位置 &lt;code&gt;/opt/graphite&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;十分简单，只需要分别安装三个组件 &lt;code&gt;graphite-web&lt;/code&gt; 、 &lt;code&gt;whisper&lt;/code&gt; 、 &lt;code&gt;carbon&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ export PYTHONPATH=&amp;quot;/opt/graphite/lib/:/opt/graphite/webapp/&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ pip3 install --no-binary=:all: https://github.com/graphite-project/whisper/tarball/master&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ pip3 install --no-binary=:all: https://github.com/graphite-project/carbon/tarball/master&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ pip3 install --no-binary=:all: https://github.com/graphite-project/graphite-web/tarball/master&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果你希望自己指定安装位置：&lt;a href=&quot;https://graphite.readthedocs.io/en/latest/install-pip.html#&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Installing From Pip&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Graphite" scheme="https://amosannn.github.io/tags/Graphite/"/>
    
  </entry>
  
  <entry>
    <title>Sqoop 之 job 工具</title>
    <link href="https://amosannn.github.io/2018/11/19/sqoop-job-guide/"/>
    <id>https://amosannn.github.io/2018/11/19/sqoop-job-guide/</id>
    <published>2018-11-19T03:20:50.000Z</published>
    <updated>2018-11-20T03:56:07.243Z</updated>
    
    <content type="html"><![CDATA[<p>本文成型的历史原因来源于使用 <code>shell</code> 脚本封装单个 <code>sqoop</code> 的脑壳疼操作</p>
<p>在执行定时任务的时候，如果需要执行的 <code>sqoop</code> 足够多，我们可以将他们封装在一个 <code>shell</code> 脚本中，再使用 <code>crontab</code> 进行定时任务调用。</p>
<p>而如果同一时间需要执行的 <code>sqoop</code> 数量仅仅只有一两个，那我们完全没有必要为了它写一个 <code>shell</code> 脚本，当然只是按场景选择不同策略，并不代表哪种方法更差。</p>
<p>对于不想多建 shell 脚本的同学，还有 <code>sqoop job</code> 这条路。</p>
<a id="more"></a>
<h2 id="job-语法"><a href="#job-语法" class="headerlink" title="job 语法"></a>job 语法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sqoop job (generic-args) (job-args) [-- [subtool-name] (subtool-args)]</div><div class="line">$ sqoop-job (generic-args) (job-args) [-- [subtool-name] (subtool-args)]</div></pre></td></tr></table></figure>
<p><code>sqoop job</code> 的语法如上所示，而其后追加的命令参数也无需按顺序堆砌。</p>
<h2 id="命令参数"><a href="#命令参数" class="headerlink" title="命令参数"></a>命令参数</h2><table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--create &lt;job-id&gt;</code></td>
<td>Define a new saved job with the specified job-id (name). A second Sqoop command-line, separated by a <code>--</code> should be specified; this defines the saved job.</td>
</tr>
<tr>
<td><code>--delete &lt;job-id&gt;</code></td>
<td>Delete a saved job.</td>
</tr>
<tr>
<td><code>--exec &lt;job-id&gt;</code></td>
<td>Given a job defined with <code>--create</code>, run the saved job.</td>
</tr>
<tr>
<td><code>--show &lt;job-id&gt;</code></td>
<td>Show the parameters for a saved job.</td>
</tr>
<tr>
<td><code>--list</code></td>
<td>List all saved jobs</td>
</tr>
</tbody>
</table>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><p>一条同步的命令大致是长这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ sqoop import </div><div class="line">  --connect jdbc:mysql://127.0.0.1:3306/tmp   \</div><div class="line">  --username amos   \</div><div class="line">  --password amos_tmp   \</div><div class="line">  --table user_log   \</div><div class="line">  --hive-import  --hive-overwrite   \</div><div class="line">  --hive-database tmp   \</div><div class="line">  --hive-table user_log   \</div><div class="line">  --hive-drop-import-delims --fields-terminated-by &apos;\001&apos; --lines-terminated-by &apos;\n&apos;  \</div><div class="line">  --compression-codec org.apache.hadoop.io.compress.SnappyCodec   \</div><div class="line">  --as-parquetfile</div></pre></td></tr></table></figure>
<p>建立 <code>sqoop job</code> 所需要的操作只需要把上面的参数追加在下面这条命令下就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sqoop job --create user_log -- import</div></pre></td></tr></table></figure>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sqoop job -delete user_log</div></pre></td></tr></table></figure>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sqoop job --exec user_log</div></pre></td></tr></table></figure>
<h3 id="查看详情"><a href="#查看详情" class="headerlink" title="查看详情"></a>查看详情</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sqoop job --show user_log</div></pre></td></tr></table></figure>
<h3 id="查看-job-列表"><a href="#查看-job-列表" class="headerlink" title="查看 job 列表"></a>查看 job 列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sqoop job --list</div><div class="line">18/11/19 02:57:58 INFO sqoop.Sqoop: Running Sqoop version: 1.4.6-cdh5.14.0</div><div class="line">Available jobs:</div><div class="line">  user_log</div></pre></td></tr></table></figure>
<h2 id="如何制定定时任务？"><a href="#如何制定定时任务？" class="headerlink" title="如何制定定时任务？"></a>如何制定定时任务？</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ crontab -e</div><div class="line">0 0 * * * sqoop job --exec user_log &gt;&gt; /home/amos/sqoop_job/user_log.log 2&gt;&amp;1</div></pre></td></tr></table></figure>
<p>仅仅是一个 <code>crontab</code> 的调用语句，简单高效。</p>
<h2 id="每次执行都需要输入数据库密码？"><a href="#每次执行都需要输入数据库密码？" class="headerlink" title="每次执行都需要输入数据库密码？"></a>每次执行都需要输入数据库密码？</h2><p><code>sqoop</code> 将它们存储数据的 <code>metastore</code> 定义为不安全的地方，所以它并没有将数据库密码存入 <code>metastore</code>，这十分合理，但如果你觉得这无所谓，可以开启存储密码的选项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi $&#123;SQOOP_HOME&#125;/conf/sqoop-site.xml</div></pre></td></tr></table></figure>
<p>增加如下内容</p>
<blockquote>
<property><br>    <name>sqoop.metastore.client.record.password</name><br>    <value>true</value><br>    <description>If true, allow saved passwords in the metastore.<br>    </description><br></property>

</blockquote>
<p>只需要在第一次执行时输入密码，之后密码就存储在 <code>metastore</code> 中了。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_job_literal" target="_blank" rel="external">sqoop-job</a></p>
<p><a href="https://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_saved_jobs_and_passwords" target="_blank" rel="external">Saved jobs and passwords</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文成型的历史原因来源于使用 &lt;code&gt;shell&lt;/code&gt; 脚本封装单个 &lt;code&gt;sqoop&lt;/code&gt; 的脑壳疼操作&lt;/p&gt;
&lt;p&gt;在执行定时任务的时候，如果需要执行的 &lt;code&gt;sqoop&lt;/code&gt; 足够多，我们可以将他们封装在一个 &lt;code&gt;shell&lt;/code&gt; 脚本中，再使用 &lt;code&gt;crontab&lt;/code&gt; 进行定时任务调用。&lt;/p&gt;
&lt;p&gt;而如果同一时间需要执行的 &lt;code&gt;sqoop&lt;/code&gt; 数量仅仅只有一两个，那我们完全没有必要为了它写一个 &lt;code&gt;shell&lt;/code&gt; 脚本，当然只是按场景选择不同策略，并不代表哪种方法更差。&lt;/p&gt;
&lt;p&gt;对于不想多建 shell 脚本的同学，还有 &lt;code&gt;sqoop job&lt;/code&gt; 这条路。&lt;/p&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Sqoop" scheme="https://amosannn.github.io/tags/Sqoop/"/>
    
      <category term="Crontab" scheme="https://amosannn.github.io/tags/Crontab/"/>
    
  </entry>
  
  <entry>
    <title>Sqoop 之常用命令与防坑指南</title>
    <link href="https://amosannn.github.io/2018/11/13/sqoop-common-command/"/>
    <id>https://amosannn.github.io/2018/11/13/sqoop-common-command/</id>
    <published>2018-11-13T06:26:55.000Z</published>
    <updated>2018-11-13T10:16:02.060Z</updated>
    
    <content type="html"><![CDATA[<p><code>Sqoop</code> 的功能十分强大，可以帮助你完成不同数据库或数据仓库之间的数据同步任务。</p>
<p>总所周知的是 Sqoop 有两个版本</p>
<ul>
<li>1.4.x </li>
<li>1.99.x</li>
</ul>
<p>它们一个代表着 sqoop1，一个代表着sqoop2，它们功能性上的异同可简单归纳为以下几点，其余差异不在本文做过多的赘述。</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>Sqoop 1</th>
<th>Sqoop 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>用于所有主要 RDBMS 的连接器</td>
<td>支持</td>
<td>不支持<br>解决办法： 使用已在以下数据库上执行测试的通用 JDBC 连接器： Microsoft SQL Server 、 PostgreSQL 、 MySQL 和 Oracle 。</td>
</tr>
<tr>
<td>Kerberos 安全集成</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>数据从 RDBMS 传输至 Hive 或 HBase</td>
<td>支持</td>
<td>不支持<br>解决办法： 按照此两步方法操作。 将数据从 RDBMS 导入 HDFS 在 Hive 中使用相应的工具和命令（例如 LOAD DATA 语句），手动将数据载入 Hive 或 HBase</td>
</tr>
<tr>
<td>数据从 Hive 或 HBase 传输至 RDBMS</td>
<td>不支持 <br>解决办法： 按照此两步方法操作。 从 Hive 或 HBase 将数据提取至 HDFS （作为文本或 Avro 文件） 使用 Sqoop 将上一步的输出导出至 RDBMS</td>
<td>不支持<br> 按照与 Sqoop 1 相同的解决方法操作</td>
</tr>
</tbody>
</table>
<p>关于两者在其他方面的异同可以参考此文：<a href="https://blog.csdn.net/Gamer_gyt/article/details/55225700" target="_blank" rel="external">Sqoop1和Sqoop2的刨析对比</a></p>
<h1 id="出发"><a href="#出发" class="headerlink" title="出发"></a>出发</h1><p>本文的背景环境为 <code>sqoop 1.4.6</code></p>
<p>sqoop 的命令格式十分简单，只需要往上累加需要的参数即可</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ sqoop help</div><div class="line">usage: sqoop COMMAND [ARGS]</div><div class="line"></div><div class="line">Available commands:</div><div class="line">  codegen            Generate code to interact with database records</div><div class="line">  create-hive-table  Import a table definition into Hive</div><div class="line">  eval               Evaluate a SQL statement and display the results</div><div class="line">  export             Export an HDFS directory to a database table</div><div class="line">  help               List available commands</div><div class="line">  import             Import a table from a database to HDFS</div><div class="line">  import-all-tables  Import tables from a database to HDFS</div><div class="line">  import-mainframe   Import mainframe datasets to HDFS</div><div class="line">  list-databases     List available databases on a server</div><div class="line">  list-tables        List available tables in a database</div><div class="line">  version            Display version information</div><div class="line"></div><div class="line">See &apos;sqoop help COMMAND&apos; for information on a specific command.</div></pre></td></tr></table></figure>
<p>这篇文章叙述的主要对象为 <code>create hive table</code>、<code>sqoop import</code> ，它们不仅仅是我最为常用的命令，也是 sqoop 家族里使用频率比较高的命令。</p>
<h1 id="通用命令参数"><a href="#通用命令参数" class="headerlink" title="通用命令参数"></a>通用命令参数</h1><p> 该表格记录了一些命令的通用操作选项：</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--connect &lt;jdbc-uri&gt;</code></td>
<td>Specify JDBC connect string</td>
</tr>
<tr>
<td><code>--connection-manager &lt;class-name&gt;</code></td>
<td>Specify connection manager class to use</td>
</tr>
<tr>
<td><code>--driver &lt;class-name&gt;</code></td>
<td>Manually specify JDBC driver class to use</td>
</tr>
<tr>
<td><code>--hadoop-mapred-home &lt;dir&gt;</code></td>
<td>Override $HADOOP_MAPRED_HOME</td>
</tr>
<tr>
<td><code>--help</code></td>
<td>Print usage instructions</td>
</tr>
<tr>
<td><code>--password-file</code></td>
<td>Set path for a file containing the authentication password</td>
</tr>
<tr>
<td><code>-P</code></td>
<td>Read password from console</td>
</tr>
<tr>
<td><code>--password &lt;password&gt;</code></td>
<td>Set authentication password</td>
</tr>
<tr>
<td><code>--username &lt;username&gt;</code></td>
<td>Set authentication username</td>
</tr>
<tr>
<td><code>--verbose</code></td>
<td>Print more information while working</td>
</tr>
<tr>
<td><code>--connection-param-file &lt;filename&gt;</code></td>
<td>Optional properties file that provides connection parameters</td>
</tr>
<tr>
<td><code>--relaxed-isolation</code></td>
<td>Set connection transaction isolation to read uncommitted for the mappers.</td>
</tr>
</tbody>
</table>
<p> 从参数名也可以看出，都是访问过程中必要的连接信息。</p>
<h1 id="Sqoop-Create-Hive-Table"><a href="#Sqoop-Create-Hive-Table" class="headerlink" title="Sqoop Create Hive Table"></a>Sqoop Create Hive Table</h1><p>如果你想复制源数据库的表结构至目标库，那就试试这条指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sqoop create-hive-table (generic-args) (create-hive-table-args)</div></pre></td></tr></table></figure>
<h2 id="Hive-参数"><a href="#Hive-参数" class="headerlink" title="Hive 参数"></a>Hive 参数</h2><table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--hive-home &lt;dir&gt;</code></td>
<td>Override <code>$HIVE_HOME</code></td>
</tr>
<tr>
<td><code>--hive-overwrite</code></td>
<td>Overwrite existing data in the Hive table.</td>
</tr>
<tr>
<td><code>--create-hive-table</code></td>
<td>If set, then the job will fail if the target hive</td>
</tr>
<tr>
<td></td>
<td>table exits. By default this property is false.</td>
</tr>
<tr>
<td><code>--hive-table &lt;table-name&gt;</code></td>
<td>Sets the table name to use when importing to Hive.</td>
</tr>
<tr>
<td><code>--table</code></td>
<td>The database table to read the definition from.</td>
</tr>
</tbody>
</table>
<h2 id="输出格式定义参数"><a href="#输出格式定义参数" class="headerlink" title="输出格式定义参数"></a>输出格式定义参数</h2><table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--enclosed-by &lt;char&gt;</code></td>
<td>Sets a required field enclosing character</td>
</tr>
<tr>
<td><code>--escaped-by &lt;char&gt;</code></td>
<td>Sets the escape character</td>
</tr>
<tr>
<td><code>--fields-terminated-by &lt;char&gt;</code></td>
<td>Sets the field separator character</td>
</tr>
<tr>
<td><code>--lines-terminated-by &lt;char&gt;</code></td>
<td>Sets the end-of-line character</td>
</tr>
<tr>
<td><code>--mysql-delimiters</code></td>
<td>Uses MySQL’s default delimiter set: fields: <code>,</code> lines: <code>\n</code> escaped-by: <code>\</code> optionally-enclosed-by: <code>&#39;</code></td>
</tr>
<tr>
<td><code>--optionally-enclosed-by &lt;char&gt;</code></td>
<td>Sets a field enclosing character</td>
</tr>
</tbody>
</table>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>其实也只需要指定相关数据库库的库名表名也就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sqoop create-hive-table </div><div class="line">    --connect jdbc:mysql://127.0.0.1:3306/tmp \</div><div class="line">    --table employees \</div><div class="line">    --hive-table emps \</div></pre></td></tr></table></figure>
<h1 id="Sqoop-import"><a href="#Sqoop-import" class="headerlink" title="Sqoop import"></a>Sqoop import</h1><p>一个完整的 <code>Sqoop</code> 命令需要由多个参数拼接而成，包括 jdbc-uri、输入输出的数据存储地址、用户名、密码以及更为复杂的可选参数等等。</p>
<h2 id="Import-参数"><a href="#Import-参数" class="headerlink" title="Import 参数"></a>Import 参数</h2><p>数据导入是个相对复杂的操作，所以参数也比单纯建表多一些：</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--append</code></td>
<td>Append data to an existing dataset in HDFS</td>
</tr>
<tr>
<td><code>--as-avrodatafile</code></td>
<td>Imports data to Avro Data Files</td>
</tr>
<tr>
<td><code>--as-sequencefile</code></td>
<td>Imports data to SequenceFiles</td>
</tr>
<tr>
<td><code>--as-textfile</code></td>
<td>Imports data as plain text (default)</td>
</tr>
<tr>
<td><code>--as-parquetfile</code></td>
<td>Imports data to Parquet Files</td>
</tr>
<tr>
<td><code>--boundary-query &lt;statement&gt;</code></td>
<td>Boundary query to use for creating splits</td>
</tr>
<tr>
<td><code>--columns &lt;col,col,col…&gt;</code></td>
<td>Columns to import from table</td>
</tr>
<tr>
<td><code>--delete-target-dir</code></td>
<td>Delete the import target directory if it exists</td>
</tr>
<tr>
<td><code>--direct</code></td>
<td>Use direct connector if exists for the database</td>
</tr>
<tr>
<td><code>--fetch-size &lt;n&gt;</code></td>
<td>Number of entries to read from database at once.</td>
</tr>
<tr>
<td><code>--inline-lob-limit &lt;n&gt;</code></td>
<td>Set the maximum size for an inline LOB</td>
</tr>
<tr>
<td><code>-m,--num-mappers &lt;n&gt;</code></td>
<td>Use <em>n</em> map tasks to import in parallel</td>
</tr>
<tr>
<td><code>-e,--query &lt;statement&gt;</code></td>
<td>Import the results of <em>statement</em>.</td>
</tr>
<tr>
<td><code>--split-by &lt;column-name&gt;</code></td>
<td>Column of the table used to split work units. Cannot be used with <code>--autoreset-to-one-mapper</code> option.</td>
</tr>
<tr>
<td><code>--autoreset-to-one-mapper</code></td>
<td>Import should use one mapper if a table has no primary key and no split-by column is provided. Cannot be used with <code>--split-by &lt;col&gt;</code> option.</td>
</tr>
<tr>
<td><code>--table &lt;table-name&gt;</code></td>
<td>Table to read</td>
</tr>
<tr>
<td><code>--target-dir &lt;dir&gt;</code></td>
<td>HDFS destination dir</td>
</tr>
<tr>
<td><code>--warehouse-dir &lt;dir&gt;</code></td>
<td>HDFS parent for table destination</td>
</tr>
<tr>
<td><code>--where &lt;where clause&gt;</code></td>
<td>WHERE clause to use during import</td>
</tr>
<tr>
<td><code>-z,--compress</code></td>
<td>Enable compression</td>
</tr>
<tr>
<td><code>--compression-codec &lt;c&gt;</code></td>
<td>Use Hadoop codec (default gzip)</td>
</tr>
<tr>
<td><code>--null-string &lt;null-string&gt;</code></td>
<td>The string to be written for a null value for string columns</td>
</tr>
<tr>
<td><code>--null-non-string &lt;null-string&gt;</code></td>
<td>The string to be written for a null value for non-string columns</td>
</tr>
</tbody>
</table>
<h2 id="说说几个比较关键的参数解读"><a href="#说说几个比较关键的参数解读" class="headerlink" title="说说几个比较关键的参数解读"></a>说说几个比较关键的参数解读</h2><blockquote>
<p>–split-by</p>
</blockquote>
<p>若源数据表中没有制定主键，将会导致执行失败，若是指定 <code>--split-by</code> 参数，程序便可根据所指定的字段进行 <code>map reduce</code> 切分。当然，由于 <code>--split-by</code> 指定的字段可能是无序甚至重复或不连续的，所以做分片的时间会非常久。</p>
<blockquote>
<p>–as-parquetfile</p>
</blockquote>
<ul>
<li>textfile</li>
<li>avrodatafile</li>
<li>sequencefile</li>
<li>parquetfile</li>
</ul>
<p>这个参数和其他几个参数一样，主要是选择存储文件的格式</p>
<p>关于 Hive 文件格式的区别，可以参考这篇文章</p>
<p><a href="http://dwgeek.com/hive-different-file-formats-text-sequence-rc-avro-orc-parquet-file.html/" target="_blank" rel="external">Apache Hive Different File Formats:TextFile,SequenceFile,RCFile,AVRO,ORC,Parquet</a></p>
<blockquote>
<p>–compression-codec</p>
</blockquote>
<p>选择压缩解码器，若是选用 <code>Snappy Compression</code> 可使用这个参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--compression-codec org.apache.hadoop.io.compress.SnappyCodec</div></pre></td></tr></table></figure>
<p>可参考 <code>CDH</code> 的官方文档</p>
<p><a href="https://www.cloudera.com/documentation/enterprise/5-6-x/topics/cdh_ig_snappy_sqoop.html" target="_blank" rel="external">Using Snappy Compression in Sqoop 1 and Sqoop 2 Imports</a></p>
<blockquote>
<p>–fields-terminated-by <char></char></p>
</blockquote>
<p>字段分隔符，数据传输难免会遇到字符串类型，这便会造成很多令你感到奇怪的事情</p>
<p>比如说字符串中自带换行符或其他字符，这些字符可能你看的见，也可能看不见</p>
<p>导致的后果是行数多了几行或者翻了几倍，这种情况很大可能就是换行符搞的鬼</p>
<p>这时你可以尝试使用下面的参数，就有很大可能可以解决你的燃眉之急</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--fields-terminated-by &apos;\001&apos;</div><div class="line">--fields-terminated-by &apos;\0001&apos;</div></pre></td></tr></table></figure>
<p>关于换行符对 Hive 造成影响的原因和解决方案强烈推荐参阅这篇文章</p>
<p><a href="https://www.marcel.is/how-newline-can-ruin-your-hive/" target="_blank" rel="external">How a newline can ruin your Hive</a></p>
<blockquote>
<p>–lines-terminated-by <char></char></p>
</blockquote>
<p>有列分隔符便有行分隔符，直接用 <code>\n</code> 就行了，能 hold 住大部分场景，这也是 <code>Sqoop</code> 默认的选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--lines-terminated-by &apos;\n&apos;</div></pre></td></tr></table></figure>
<blockquote>
<p>–hive-overwrite</p>
</blockquote>
<p>有了这个参数，就可以覆盖同步了，免去了手动 drop 表的操作</p>
<h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h2><p>可以做为模板使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ sqoop import --connect jdbc:mysql://127.0.0.1:3306/tmp   \</div><div class="line">  --username amos   \</div><div class="line">  --password amos_tmp   \</div><div class="line">  --table user_account_statement   \</div><div class="line">  --hive-import  --hive-overwrite   \</div><div class="line">  --hive-database tmp   \</div><div class="line">  --hive-table user_account_statement   \</div><div class="line">  --hive-drop-import-delims --fields-terminated-by &apos;\001&apos; --lines-terminated-by &apos;\n&apos;  \</div><div class="line">  --compression-codec org.apache.hadoop.io.compress.SnappyCodec   \</div><div class="line">  --as-parquetfile</div></pre></td></tr></table></figure>
<h2 id="自由格式查询导入"><a href="#自由格式查询导入" class="headerlink" title="自由格式查询导入"></a>自由格式查询导入</h2><p>相比上面的传统做法，还有一种更猛的，可以实现数据的高度定制。</p>
<p>就是使用 SQL 来实现结果集导入，其实上面部分参数的存在意义也就是拼凑出一段 SQL 而已。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sqoop import \</div><div class="line">  --query &apos;SELECT a.*, b.* FROM a JOIN b on (a.id == b.id) WHERE a.create_time&gt;1542097292&apos; \</div><div class="line">  --split-by a.id \</div><div class="line">  --target-dir /user/amos/joinresults</div></pre></td></tr></table></figure>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Sqoop&lt;/code&gt; 的功能十分强大，可以帮助你完成不同数据库或数据仓库之间的数据同步任务。&lt;/p&gt;
&lt;p&gt;总所周知的是 Sqoop 有两个版本&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.4.x &lt;/li&gt;
&lt;li&gt;1.99.x&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;它们一个代表着 sqoop1，一个代表着sqoop2，它们功能性上的异同可简单归纳为以下几点，其余差异不在本文做过多的赘述。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;功能&lt;/th&gt;
&lt;th&gt;Sqoop 1&lt;/th&gt;
&lt;th&gt;Sqoop 2&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;用于所有主要 RDBMS 的连接器&lt;/td&gt;
&lt;td&gt;支持&lt;/td&gt;
&lt;td&gt;不支持&lt;br&gt;解决办法： 使用已在以下数据库上执行测试的通用 JDBC 连接器： Microsoft SQL Server 、 PostgreSQL 、 MySQL 和 Oracle 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Kerberos 安全集成&lt;/td&gt;
&lt;td&gt;支持&lt;/td&gt;
&lt;td&gt;不支持&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;数据从 RDBMS 传输至 Hive 或 HBase&lt;/td&gt;
&lt;td&gt;支持&lt;/td&gt;
&lt;td&gt;不支持&lt;br&gt;解决办法： 按照此两步方法操作。 将数据从 RDBMS 导入 HDFS 在 Hive 中使用相应的工具和命令（例如 LOAD DATA 语句），手动将数据载入 Hive 或 HBase&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;数据从 Hive 或 HBase 传输至 RDBMS&lt;/td&gt;
&lt;td&gt;不支持 &lt;br&gt;解决办法： 按照此两步方法操作。 从 Hive 或 HBase 将数据提取至 HDFS （作为文本或 Avro 文件） 使用 Sqoop 将上一步的输出导出至 RDBMS&lt;/td&gt;
&lt;td&gt;不支持&lt;br&gt; 按照与 Sqoop 1 相同的解决方法操作&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;关于两者在其他方面的异同可以参考此文：&lt;a href=&quot;https://blog.csdn.net/Gamer_gyt/article/details/55225700&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Sqoop1和Sqoop2的刨析对比&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;出发&quot;&gt;&lt;a href=&quot;#出发&quot; class=&quot;headerlink&quot; title=&quot;出发&quot;&gt;&lt;/a&gt;出发&lt;/h1&gt;&lt;p&gt;本文的背景环境为 &lt;code&gt;sqoop 1.4.6&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;sqoop 的命令格式十分简单，只需要往上累加需要的参数即可&lt;/p&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="MySQL" scheme="https://amosannn.github.io/tags/MySQL/"/>
    
      <category term="Sqoop" scheme="https://amosannn.github.io/tags/Sqoop/"/>
    
      <category term="Hive" scheme="https://amosannn.github.io/tags/Hive/"/>
    
      <category term="CDH" scheme="https://amosannn.github.io/tags/CDH/"/>
    
  </entry>
  
  <entry>
    <title>Impala 优化之统计数据预存储「compute stats」</title>
    <link href="https://amosannn.github.io/2018/11/12/impala-compute-stats/"/>
    <id>https://amosannn.github.io/2018/11/12/impala-compute-stats/</id>
    <published>2018-11-12T04:25:42.000Z</published>
    <updated>2018-11-12T11:53:40.490Z</updated>
    
    <content type="html"><![CDATA[<p>由于大表关联，分析同学的执行操作要得出结果往往需要好几分钟，这在千万级、亿级数据量的表之间关联得出结果，不能说是很慢，但是依旧有着可提升的空间。</p>
<h2 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h2><p>在 <code>Impala</code> 中，有一个神秘指令，COMPUTE STATS</p>
<p>它可以预先分析表和列的的结构，并将其存储在元数据中。等到执行查询的时候， <code>Impala</code> 便会根据存储的元数据做出相应的查询优化。</p>
<p>也就是下面这条语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">COMPUTE STATS t1;</div></pre></td></tr></table></figure>
<h3 id="执行前"><a href="#执行前" class="headerlink" title="执行前"></a>执行前</h3><blockquote>
<p>show table stats t1;</p>
</blockquote>
<table>
<thead>
<tr>
<th>#Rows</th>
<th>#Files</th>
<th>Size</th>
<th>Bytes Cached</th>
<th>Cache Replication</th>
<th>Format</th>
<th>Incremental stats</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td>-1</td>
<td>4</td>
<td>1.72GB</td>
<td>NOT CACHED</td>
<td>NOT CACHED</td>
<td>PARQUET</td>
<td>false</td>
<td>hdfs://nameservice1/user/hive/warehouse/t1</td>
</tr>
</tbody>
</table>
<blockquote>
<p>show column stats t1;</p>
</blockquote>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>#Distinct Values</th>
<th>#Nulls</th>
<th>Max Size</th>
<th>Avg Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>BIGINT</td>
<td>-1</td>
<td>-1</td>
<td>8</td>
<td>8</td>
</tr>
<tr>
<td>type</td>
<td>INT</td>
<td>-1</td>
<td>-1</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td>uid</td>
<td>BIGINT</td>
<td>-1</td>
<td>-1</td>
<td>8</td>
<td>8</td>
</tr>
</tbody>
</table>
<h3 id="执行后"><a href="#执行后" class="headerlink" title="执行后"></a>执行后</h3><blockquote>
<p>show table stats t1;</p>
</blockquote>
<table>
<thead>
<tr>
<th>#Rows</th>
<th>#Files</th>
<th>Size</th>
<th>Bytes Cached</th>
<th>Cache Replication</th>
<th>Format</th>
<th>Incremental stats</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td>32233129</td>
<td>4</td>
<td>1.72GB</td>
<td>NOT CACHED</td>
<td>NOT CACHED</td>
<td>PARQUET</td>
<td>false</td>
<td>hdfs://nameservice1/user/hive/warehouse/t1</td>
</tr>
</tbody>
</table>
<blockquote>
<p>show column stats t1;</p>
</blockquote>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>#Distinct Values</th>
<th>#Nulls</th>
<th>Max Size</th>
<th>Avg Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>BIGINT</td>
<td>45300013</td>
<td>0</td>
<td>8</td>
<td>8</td>
</tr>
<tr>
<td>type</td>
<td>INT</td>
<td>14</td>
<td>0</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td>uid</td>
<td>BIGINT</td>
<td>2831250</td>
<td>0</td>
<td>8</td>
<td>8</td>
</tr>
</tbody>
</table>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从上面的表格可以看出，<code>compute stats</code> 为我们缓存了几个较为常用的 count 值，不要小看这几个值。</p>
<p>在大型连表查询中，相比未经过 <code>compute stats</code> 优化的速度提升是几倍甚至十几倍，而相对 hive 的相同查询操作，速度差距将会达到几十倍。</p>
<h2 id="Hive-依然适用"><a href="#Hive-依然适用" class="headerlink" title="Hive 依然适用"></a>Hive 依然适用</h2><p>如果想在 hive 中执行，Impala 中查询，也可在 Hive 中执行操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ANALYZE TABLE Table1 COMPUTE STATISTICS;</div><div class="line">ANALYZE TABLE Table1 COMPUTE STATISTICS FOR COLUMNS;</div></pre></td></tr></table></figure>
<hr>
<h2 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h2><p><a href="https://www.cloudera.com/documentation/enterprise/5-9-x/topics/impala_compute_stats.html" target="_blank" rel="external">COMPUTE STATS Statement</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;由于大表关联，分析同学的执行操作要得出结果往往需要好几分钟，这在千万级、亿级数据量的表之间关联得出结果，不能说是很慢，但是依旧有着可提升的空间。&lt;/p&gt;
&lt;h2 id=&quot;探索&quot;&gt;&lt;a href=&quot;#探索&quot; class=&quot;headerlink&quot; title=&quot;探索&quot;&gt;&lt;/a&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Impala" scheme="https://amosannn.github.io/tags/Impala/"/>
    
  </entry>
  
  <entry>
    <title>Airflow 居然趁服务器不注意卡在 running 状态不执行</title>
    <link href="https://amosannn.github.io/2018/11/01/airflow-dag-get-stuck-in-running-state/"/>
    <id>https://amosannn.github.io/2018/11/01/airflow-dag-get-stuck-in-running-state/</id>
    <published>2018-11-01T03:11:16.000Z</published>
    <updated>2018-11-06T07:54:34.227Z</updated>
    
    <content type="html"><![CDATA[<p>就像这样，这小子坏得很。</p>
<p><img src="/images/airflow/1541489895790.png" alt="1541489895790"></p>
<h2 id="初现端倪"><a href="#初现端倪" class="headerlink" title="初现端倪"></a>初现端倪</h2><p>好在 <code>Task Instance Details</code> 中可以看到这小子心里都在想些啥，这是十分关键的，以及具有重大突破性的调查入口！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">depends_on_past is true for this task&apos;s DAG, but the previous task instance has not run yet.</div></pre></td></tr></table></figure>
<p>做为一个新来的 dag，旗下每一个格子都是小白块，怎么可能会有前置依赖没执行？十分任性！</p>
<h2 id="顺藤摸瓜"><a href="#顺藤摸瓜" class="headerlink" title="顺藤摸瓜"></a>顺藤摸瓜</h2><p>找到问题所在就好办了</p>
<p>前往代码中查看，我确实将 <code>depends_on_past</code> 置为 True` 了，但是每个 task 之间的依赖更是没有问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">default_args = &#123;</div><div class="line">    &apos;owner&apos;: &apos;amos&apos;,</div><div class="line">    &apos;depends_on_past&apos;: True,</div><div class="line">    # &apos;start_date&apos;: airflow.utils.dates.days_ago(1),</div><div class="line">    &apos;start_date&apos;: datetime.now(),</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>尝试着将 <code>depends_on_past</code> 置为 <code>False</code> ，Airflow 立马开始了属于他自己的奔跑（按照依赖关系奔跑）！</p>
<h2 id="别出纰漏"><a href="#别出纰漏" class="headerlink" title="别出纰漏"></a>别出纰漏</h2><p>顺便一提，还有一种可能会导致这种情况的发生</p>
<p>那就是没有开启这个 dag，也就是 <code>trigger</code> 的状态为 <code>off</code>，这样会把任务挂起，直至开启 dag 才会执行。</p>
<hr>
<h2 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h2><p><a href="https://stackoverflow.com/questions/51261841/airflow-dag-get-stuck-in-running-state" target="_blank" rel="external">AirFlow DAG Get stuck in running state</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;就像这样，这小子坏得很。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/airflow/1541489895790.png&quot; alt=&quot;1541489895790&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;初现端倪&quot;&gt;&lt;a href=&quot;#初现端倪&quot; class=&quot;headerlink
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Airflow" scheme="https://amosannn.github.io/tags/Airflow/"/>
    
  </entry>
  
  <entry>
    <title>Airflow 不遵循调度配置执行</title>
    <link href="https://amosannn.github.io/2018/10/31/airflow-dag-does-not-follow-the-schedule-configuration-execution/"/>
    <id>https://amosannn.github.io/2018/10/31/airflow-dag-does-not-follow-the-schedule-configuration-execution/</id>
    <published>2018-10-31T08:45:11.000Z</published>
    <updated>2018-11-06T08:40:19.598Z</updated>
    
    <content type="html"><![CDATA[<p>在 Airflow 的使用过程中，曾多次遇到令人惊奇的现象，其中之一便是它没有按照 dag 中的配置执行。</p>
<p>可能你也会遇到这样的情况，为什么配置了 <code>schedule_interval</code> 和 <code>start_date</code>，但是依旧没有按照调度配置的时间自动执行。</p>
<h2 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h2><p>比如我这么配：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta, timedelta</div><div class="line"></div><div class="line">default_args = &#123;</div><div class="line">    <span class="string">'owner'</span>: <span class="string">'amos'</span>,</div><div class="line">    <span class="string">'depends_on_past'</span>: <span class="keyword">False</span>,</div><div class="line">    <span class="string">'start_date'</span>: datetime.now(),</div><div class="line">&#125;</div><div class="line"></div><div class="line">dag = DAG(<span class="string">'test_rerun_dag'</span>,</div><div class="line">          default_args=default_args,</div><div class="line">          description=<span class="string">'test_rerun_dag'</span>,</div><div class="line">          schedule_interval=<span class="string">"*/1 * * * *"</span>)</div></pre></td></tr></table></figure>
<p>照理说它应该按照配置中写的，每分钟执行一次操作。可是它没有，是它变心了吗？</p>
<p>不，不是的。</p>
<h2 id="这究竟是为什么"><a href="#这究竟是为什么" class="headerlink" title="这究竟是为什么"></a>这究竟是为什么</h2><blockquote>
<p>Airflow sets execution_date based on the left bound of the schedule period it is covering, not based on when it fires (which would be the right bound of the period) .</p>
</blockquote>
<p>原因在于 Airflow 是个有原则的程序，它有个窗口的概念，会把 start_date 开始后，符合 schedule_interval 定义的第一个时间点记为 execution_date，但是会在下个时间点到达时才开始运行。也就是说由于这个窗口的原因，last run 会滞后一个周期。 </p>
<p>所以，按上面的配置来说，每次当 scheduler 读到了这段 DAG，它会拿小本本记下 start_date 和每分钟执行的操作，准备在下一分钟开始执行了。但是当下一分钟来临的时候，它看了看表，嗯！start_date + 1，那么 execution_date 也 + 1，于是把小本本上的 start_date 划掉重写。所以 start_date 在不断被覆盖的过程中，任务没有像我们预想中的在调度奔跑，反而一直是挂起状态。</p>
<h2 id="这可咋整啊"><a href="#这可咋整啊" class="headerlink" title="这可咋整啊"></a>这可咋整啊</h2><p>那么如何才能真正地让它规律地执行呢？</p>
<p>将 start_date 往前错位到上一个周期</p>
<p>什么意思呢？假如本例中的每分钟执行一次，那就将 start_date 调整到上一分钟的状态</p>
<blockquote>
<p><del>‘start_date’: datetime.now()</del></p>
<p>‘start_date’: datetime.now() - timedelta(minutes=1)</p>
</blockquote>
<p>这下 scheduler 就可以在小本本工工整整地记录每一次调度计划，而不用写了划，划了写，把小本本涂得黑黑的了！</p>
<hr>
<p>如果你的 dag 趁你不注意卡在running 状态下不能动弹，或许你可以改改调度时间或周期。</p>
<p>或者试试参考这篇文章：<a href="/2018/11/01/airflow-dag-get-stuck-in-running-state/" title="Airflow 居然趁服务器不注意卡在 running 状态不执行">Airflow 居然趁服务器不注意卡在 running 状态不执行</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在 Airflow 的使用过程中，曾多次遇到令人惊奇的现象，其中之一便是它没有按照 dag 中的配置执行。&lt;/p&gt;
&lt;p&gt;可能你也会遇到这样的情况，为什么配置了 &lt;code&gt;schedule_interval&lt;/code&gt; 和 &lt;code&gt;start_date&lt;/code&gt;
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Airflow" scheme="https://amosannn.github.io/tags/Airflow/"/>
    
  </entry>
  
  <entry>
    <title>Airflow 概念梳理</title>
    <link href="https://amosannn.github.io/2018/10/30/airflow-concept-combing/"/>
    <id>https://amosannn.github.io/2018/10/30/airflow-concept-combing/</id>
    <published>2018-10-30T11:18:16.000Z</published>
    <updated>2018-11-26T07:44:59.247Z</updated>
    
    <content type="html"><![CDATA[<h1 id="有向无环图"><a href="#有向无环图" class="headerlink" title="有向无环图"></a>有向无环图</h1><p>Airflow 基于一个重要的数据结构，DAG。</p>
<p>为什么依赖 DAG？</p>
<p>LInux 与 WIndows 的 crontab 与任务计划，只可以配置定时任务或间隔任务，无法配置作业间的依赖关系。</p>
<p>一个很大的弊端是，如果我们需要在作业 A 执行之后才有供作业 B 执行的数据，而出现了不可因素导致轮到作业 B 执行的时候作业 A 还未执行完毕。这必定会导致数据缺失，或作业 B 执行失败。</p>
<p>所以，使用有向无环图来定义作业流，在任务调度中是非常合适的。</p>
<h1 id="基础服务"><a href="#基础服务" class="headerlink" title="基础服务"></a>基础服务</h1><h2 id="Webserver"><a href="#Webserver" class="headerlink" title="Webserver"></a>Webserver</h2><p>是 Airflow 的基础服务，提供了前端可视化管理工具，可视化才是最好的！</p>
<p>你可以在上面执行调度操作，查看任务处理耗时分析，清除状态作业重跑，查看日志，管理用户和数据连接，以及配置的 DAG 是否正确等。</p>
<h2 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h2><p>也是 Airflow 的基础服务之一，身为调度器，负责监控 DAG 的状态，计算调度时间，启动满足条件的 DAG，并将任务提交到 Executor。</p>
<h2 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h2><p>工作节点，这个角色类似于 yarn 中的 namenode，直接负责 Executor 的执行分配。</p>
<p>ps: yarn 为 hadoop 中的资源管理系统</p>
<h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p>Airflow 有三种执行器</p>
<ul>
<li><p>SequentialExecutor </p>
<p>顺序执行器，无需额外配置，默认使用 sqlite 作为元数据，因此也无法支持任务之间的并发操作。</p>
</li>
<li><p>LocalExecutor</p>
<p>本地执行器，不支持 sqlite，但可使用 mysql、oracle、postgress 等主流数据库，需配置数据库链接 URL。</p>
</li>
<li><p>CeleryExecutor</p>
<p>江湖人称芹菜，是一款基于消息队列的分布式异步任务调度工具，可将任务运行在千里之外（远程节点），十分优秀！</p>
<p>ps: 需执行 Airflow 的工作节点 <code>airflow worker</code></p>
<p>pps: 需额外安装 <code>Redis</code> 或 <code>RabbitMQ</code> 等</p>
</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h2><p>有了作业流，就得有作业内容，Operators 就是做这事的。</p>
<p>Airflow 目前支持十多种不同的作业类型</p>
<ul>
<li>BashOperator</li>
<li>PythonOperator</li>
<li>DockerOperator</li>
<li>DruidCheckOperator</li>
<li>EmailOperator</li>
<li>HiveOperator</li>
<li>HTTPOperator</li>
<li>DummyOperator </li>
<li>……</li>
</ul>
<p>他们的作用都像字面意思说的那样，可完成相应的操作或调用。</p>
<p>值得注意的是 DummyOperator，是个空操作，相当于标记和中转节点。</p>
<p>当然，他们有一个共同的爸爸「BaseOperator」，中央集权，他一人的修改会改变儿子们继承到的功能。</p>
<h2 id="Timezone"><a href="#Timezone" class="headerlink" title="Timezone"></a>Timezone</h2><p>在 1.9 版本及以前，Airflow 使用的是本地时间，不同服务器时区不同容易产生运行错误。</p>
<p>而在 1.10 中，加入了自定义的时区配置（1.9 的时区配置无法生效，大坑。。）</p>
<h2 id="预警与监控"><a href="#预警与监控" class="headerlink" title="预警与监控"></a>预警与监控</h2><p>当任务执行失败或状态异常时，发送短信或邮件。</p>
<p>这是个棒棒的功能，守卫再严的城池也有失守的时候，硝烟一起，家书即刻送达。</p>
<p>你说，这为镇守襄阳城提供多少便利？</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;有向无环图&quot;&gt;&lt;a href=&quot;#有向无环图&quot; class=&quot;headerlink&quot; title=&quot;有向无环图&quot;&gt;&lt;/a&gt;有向无环图&lt;/h1&gt;&lt;p&gt;Airflow 基于一个重要的数据结构，DAG。&lt;/p&gt;
&lt;p&gt;为什么依赖 DAG？&lt;/p&gt;
&lt;p&gt;LInux 与 
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="Airflow" scheme="https://amosannn.github.io/tags/Airflow/"/>
    
  </entry>
  
  <entry>
    <title>Airflow 安装及跳坑指南</title>
    <link href="https://amosannn.github.io/2018/10/29/airflow_install_and_more/"/>
    <id>https://amosannn.github.io/2018/10/29/airflow_install_and_more/</id>
    <published>2018-10-29T11:58:16.000Z</published>
    <updated>2019-01-08T04:22:54.243Z</updated>
    
    <content type="html"><![CDATA[<h2 id="有啥用"><a href="#有啥用" class="headerlink" title="有啥用"></a>有啥用</h2><p><code>Airflow</code> 简单来说就是管理和调度各种离线定时的 Job，用以替代 <code>crontab</code>， 可以把它看作是个高级版的 <code>crontab</code>。</p>
<p>如果 <code>crontab</code>  的规模达到百千万，管理起来会非常复杂。这个时候可以考虑将任务迁移到 <code>Airflow</code>，你将可以清楚地分辨出哪些 DAG 是稳定的，哪些不那么见状，需要优化。如果 DAG 不足以打动你，强交互性、友好的界面管理、重跑任务以及合适的报警级别足以让你感觉相见恨晚。</p>
<h2 id="简单记录安装及配置过程"><a href="#简单记录安装及配置过程" class="headerlink" title="简单记录安装及配置过程"></a>简单记录安装及配置过程</h2><p><code>Airflow</code> 在 1.8 之后更名为 <code>apache-airflow</code></p>
<blockquote>
<p>NOTE: The transition from 1.8.0 (or before) to 1.8.1 (or after) requires uninstalling Airflow before installing the new version. The package name was changed from airflow to apache-airflow as of version 1.8.1.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip3 install apache-airflow</div></pre></td></tr></table></figure>
<p>如果你想安装 1.8.0 的 <code>Airflow</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip3 install airflow</div></pre></td></tr></table></figure>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ airflow initdb</div></pre></td></tr></table></figure>
<p>初始化后默认会在 <code>~/</code> 下生成 <code>airflow</code> 文件夹，如果想更换 <code>MySQL</code> 或其他数据库做为元数据存储，那么在配置文件中修改配置后重新初始化即可。</p>
<p>关于如何在 python3 中安装 <code>MySQL</code>，此处不做赘述。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ vi ~/airflow/airflow.cfg</div><div class="line">sql_alchemy_conn = mysql://username:password@host:port/airflow</div></pre></td></tr></table></figure>
<h2 id="安装扩展"><a href="#安装扩展" class="headerlink" title="安装扩展"></a>安装扩展</h2><p><code>Airflow</code> 内置了芹菜的调度器，只需要手动安装芹菜并进行简单配置就可以使用。</p>
<p><code>Celery</code> 可使用 <code>RabbitMQ</code> 或 <code>Redis</code> 做为 broker，按需选择即可，此处也不做赘述。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ pip3 install apache-airflow[celery]</div><div class="line"></div><div class="line"># 启用还需修改几处配置</div><div class="line">$ vi ~/airflow/airflow.cfg</div><div class="line">executor = CeleryExecutor</div><div class="line">broker_url = redis://127.0.0.1:6379/0</div><div class="line">result_backend = db+mysql://root:xxx@127.0.0.1:3306/airflow</div></pre></td></tr></table></figure>
<h3 id="这里有一个可能会踩入的小坑"><a href="#这里有一个可能会踩入的小坑" class="headerlink" title="这里有一个可能会踩入的小坑"></a>这里有一个可能会踩入的小坑</h3><p>既然项目更名了，在安装芹菜等扩展时，记得选对项目。</p>
<p>否则便会安装两个项目，导致后期使用出现冲突。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ pip3 install apache-airflow</div><div class="line">$ pip3 install airflow[celery]</div><div class="line"></div><div class="line">$ pip3 list</div><div class="line">...</div><div class="line">apache-airflow (1.10.0)</div><div class="line">airflow (1.8.0)</div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 启动 webserver</div><div class="line">$ airflow webserver -p 8080</div><div class="line"># 启动调度程序</div><div class="line">$ airflow scheduler</div><div class="line"># 启动 Celery</div><div class="line">$ airflow worker</div></pre></td></tr></table></figure>
<p>启动完成后就可以运行官方内置的 example 测试啦！</p>
<h2 id="大坑"><a href="#大坑" class="headerlink" title="大坑"></a>大坑</h2><p>记录几个遇到的报错</p>
<h3 id="airflow-exceptions-AirflowException-Could-not-create-Fernet-object-Incorrect-padding"><a href="#airflow-exceptions-AirflowException-Could-not-create-Fernet-object-Incorrect-padding" class="headerlink" title="airflow.exceptions.AirflowException: Could not create Fernet object: Incorrect padding"></a>airflow.exceptions.AirflowException: Could not create Fernet object: Incorrect padding</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">$ airflow initdb</div><div class="line">[2018-10-30 15:30:26,857] &#123;settings.py:174&#125; INFO - setting.configure_orm(): Using pool settings. pool_size=5, pool_recycle=1800</div><div class="line">[2018-10-30 15:30:27,164] &#123;__init__.py:51&#125; INFO - Using executor CeleryExecutor</div><div class="line">DB: mysql://root:***@localhost:3306/airflow</div><div class="line">[2018-10-30 15:30:27,320] &#123;db.py:338&#125; INFO - Creating tables</div><div class="line">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</div><div class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/models.py&quot;, line 159, in get_fernet</div><div class="line">    _fernet = Fernet(configuration.conf.get(&apos;core&apos;, &apos;FERNET_KEY&apos;).encode(&apos;utf-8&apos;))</div><div class="line">  File &quot;/usr/lib/python3/dist-packages/cryptography/fernet.py&quot;, line 34, in __init__</div><div class="line">    key = base64.urlsafe_b64decode(key)</div><div class="line">  File &quot;/usr/lib/python3.5/base64.py&quot;, line 134, in urlsafe_b64decode</div><div class="line">    return b64decode(s)</div><div class="line">  File &quot;/usr/lib/python3.5/base64.py&quot;, line 88, in b64decode</div><div class="line">    return binascii.a2b_base64(s)</div><div class="line">binascii.Error: Incorrect padding</div><div class="line"></div><div class="line">During handling of the above exception, another exception occurred:</div><div class="line"></div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/home/ubuntu/.local/bin/airflow&quot;, line 32, in &lt;module&gt;</div><div class="line">    args.func(args)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/bin/cli.py&quot;, line 1002, in initdb</div><div class="line">    db_utils.initdb(settings.RBAC)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/utils/db.py&quot;, line 103, in initdb</div><div class="line">    schema=&apos;airflow_ci&apos;))</div><div class="line">  File &quot;&lt;string&gt;&quot;, line 4, in __init__</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/sqlalchemy/orm/state.py&quot;, line 414, in _initialize_instance</div><div class="line">    manager.dispatch.init_failure(self, args, kwargs)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/sqlalchemy/util/langhelpers.py&quot;, line 66, in __exit__</div><div class="line">    compat.reraise(exc_type, exc_value, exc_tb)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/sqlalchemy/util/compat.py&quot;, line 187, in reraise</div><div class="line">    raise value</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/sqlalchemy/orm/state.py&quot;, line 411, in _initialize_instance</div><div class="line">    return manager.original_init(*mixed[1:], **kwargs)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/models.py&quot;, line 677, in __init__</div><div class="line">    self.extra = extra</div><div class="line">  File &quot;&lt;string&gt;&quot;, line 1, in __set__</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/models.py&quot;, line 731, in set_extra</div><div class="line">    fernet = get_fernet()</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/models.py&quot;, line 163, in get_fernet</div><div class="line">    raise AirflowException(&quot;Could not create Fernet object: &#123;&#125;&quot;.format(ve))</div><div class="line">airflow.exceptions.AirflowException: Could not create Fernet object: Incorrect padding</div></pre></td></tr></table></figure>
<h4 id="fernet-key"><a href="#fernet-key" class="headerlink" title="fernet_key"></a>fernet_key</h4><p>关于 <code>fernet_key</code> 是什么，配置文件里给出了相应的解释：</p>
<blockquote>
<p>Secret key to save connection passwords in the db</p>
</blockquote>
<h4 id="干掉它"><a href="#干掉它" class="headerlink" title="干掉它"></a>干掉它</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 生成一个 key 替换配置文件中的 fernet_key</div><div class="line">$ python3 -c &quot;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&quot;</div><div class="line"></div><div class="line">$ vi ~/airflow/airflow.cfg</div><div class="line">fernet_key = g3589dfasdfhnht289tghdsfij---dfadfgeu812=</div><div class="line"></div><div class="line">$ airflow initdb</div><div class="line">[2018-10-30 15:31:21,159] &#123;settings.py:174&#125; INFO - setting.configure_orm(): Using pool settings. pool_size=5, pool_recycle=1800</div><div class="line">[2018-10-30 15:31:21,464] &#123;__init__.py:51&#125; INFO - Using executor CeleryExecutor</div><div class="line">DB: mysql://root:***@localhost:3306/airflow</div><div class="line">[2018-10-30 15:31:21,620] &#123;db.py:338&#125; INFO - Creating tables</div><div class="line">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</div><div class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</div><div class="line">Done.</div></pre></td></tr></table></figure>
<h3 id="TypeError-b’5e36be93294a6fea65a4c81571388241b1667fca’-is-not-JSON-serializable"><a href="#TypeError-b’5e36be93294a6fea65a4c81571388241b1667fca’-is-not-JSON-serializable" class="headerlink" title="TypeError: b’5e36be93294a6fea65a4c81571388241b1667fca’ is not JSON serializable"></a>TypeError: b’5e36be93294a6fea65a4c81571388241b1667fca’ is not JSON serializable</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line">Ooops.</div><div class="line"></div><div class="line">                          ____/ (  (    )   )  \___</div><div class="line">                         /( (  (  )   _    ))  )   )\</div><div class="line">                       ((     (   )(    )  )   (   )  )</div><div class="line">                     ((/  ( _(   )   (   _) ) (  () )  )</div><div class="line">                    ( (  ( (_)   ((    (   )  .((_ ) .  )_</div><div class="line">                   ( (  )    (      (  )    )   ) . ) (   )</div><div class="line">                  (  (   (  (   ) (  _  ( _) ).  ) . ) ) ( )</div><div class="line">                  ( (  (   ) (  )   (  ))     ) _)(   )  )  )</div><div class="line">                 ( (  ( \ ) (    (_  ( ) ( )  )   ) )  )) ( )</div><div class="line">                  (  (   (  (   (_ ( ) ( _    )  ) (  )  )   )</div><div class="line">                 ( (  ( (  (  )     (_  )  ) )  _)   ) _( ( )</div><div class="line">                  ((  (   )(    (     _    )   _) _(_ (  (_ )</div><div class="line">                   (_((__(_(__(( ( ( |  ) ) ) )_))__))_)___)</div><div class="line">                   ((__)        \\||lll|l||///          \_))</div><div class="line">                            (   /(/ (  )  ) )\   )</div><div class="line">                          (    ( ( ( | | ) ) )\   )</div><div class="line">                           (   /(| / ( )) ) ) )) )</div><div class="line">                         (     ( ((((_(|)_)))))     )</div><div class="line">                          (      ||\(|(|)|/||     )</div><div class="line">                        (        |(||(||)||||        )</div><div class="line">                          (     //|/l|||)|\\ \     )</div><div class="line">                        (/ / //  /|//||||\\  \ \  \ _)</div><div class="line">-------------------------------------------------------------------------------</div><div class="line">Node: ubuntu</div><div class="line">-------------------------------------------------------------------------------</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/app.py&quot;, line 1982, in wsgi_app</div><div class="line">    response = self.full_dispatch_request()</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/app.py&quot;, line 1614, in full_dispatch_request</div><div class="line">    rv = self.handle_user_exception(e)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/app.py&quot;, line 1517, in handle_user_exception</div><div class="line">    reraise(exc_type, exc_value, tb)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/_compat.py&quot;, line 33, in reraise</div><div class="line">    raise value</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/app.py&quot;, line 1612, in full_dispatch_request</div><div class="line">    rv = self.dispatch_request()</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/app.py&quot;, line 1598, in dispatch_request</div><div class="line">    return self.view_functions[rule.endpoint](**req.view_args)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask_admin/base.py&quot;, line 69, in inner</div><div class="line">    return self._run_view(f, *args, **kwargs)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask_admin/base.py&quot;, line 368, in _run_view</div><div class="line">    return fn(self, *args, **kwargs)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask_login.py&quot;, line 755, in decorated_view</div><div class="line">    return func(*args, **kwargs)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/utils/db.py&quot;, line 74, in wrapper</div><div class="line">    return func(*args, **kwargs)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/www/views.py&quot;, line 2061, in index</div><div class="line">    auto_complete_data=auto_complete_data)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask_admin/base.py&quot;, line 308, in render</div><div class="line">    return render_template(template, **kwargs)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/templating.py&quot;, line 134, in render_template</div><div class="line">    context, ctx.app)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask/templating.py&quot;, line 116, in _render</div><div class="line">    rv = template.render(context)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/jinja2/environment.py&quot;, line 989, in render</div><div class="line">    return self.environment.handle_exception(exc_info, True)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/jinja2/environment.py&quot;, line 754, in handle_exception</div><div class="line">    reraise(exc_type, exc_value, tb)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/jinja2/_compat.py&quot;, line 37, in reraise</div><div class="line">    raise value.with_traceback(tb)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/www/templates/airflow/dags.html&quot;, line 18, in top-level template code</div><div class="line">    &#123;% extends &quot;airflow/master.html&quot; %&#125;</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/www/templates/airflow/master.html&quot;, line 18, in top-level template code</div><div class="line">    &#123;% extends &quot;admin/master.html&quot; %&#125;</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/www/templates/admin/master.html&quot;, line 18, in top-level template code</div><div class="line">    &#123;% extends &apos;admin/base.html&apos; %&#125;</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask_admin/templates/bootstrap3/admin/base.html&quot;, line 74, in top-level template code</div><div class="line">    &#123;% block tail_js %&#125;</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/airflow/www/templates/admin/master.html&quot;, line 44, in block &quot;tail_js&quot;</div><div class="line">    xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;&#123;&#123; csrf_token() &#125;&#125;&quot;);</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/flask_wtf/csrf.py&quot;, line 47, in generate_csrf</div><div class="line">    setattr(g, field_name, s.dumps(session[field_name]))</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/itsdangerous/serializer.py&quot;, line 166, in dumps</div><div class="line">    payload = want_bytes(self.dump_payload(obj))</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/itsdangerous/url_safe.py&quot;, line 42, in dump_payload</div><div class="line">    json = super(URLSafeSerializerMixin, self).dump_payload(obj)</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/itsdangerous/serializer.py&quot;, line 133, in dump_payload</div><div class="line">    return want_bytes(self.serializer.dumps(obj, **self.serializer_kwargs))</div><div class="line">  File &quot;/home/ubuntu/.local/lib/python3.5/site-packages/itsdangerous/_json.py&quot;, line 18, in dumps</div><div class="line">    return json.dumps(obj, **kwargs)</div><div class="line">  File &quot;/usr/lib/python3.5/json/__init__.py&quot;, line 237, in dumps</div><div class="line">    **kw).encode(obj)</div><div class="line">  File &quot;/usr/lib/python3.5/json/encoder.py&quot;, line 198, in encode</div><div class="line">    chunks = self.iterencode(o, _one_shot=True)</div><div class="line">  File &quot;/usr/lib/python3.5/json/encoder.py&quot;, line 256, in iterencode</div><div class="line">    return _iterencode(o, 0)</div><div class="line">  File &quot;/usr/lib/python3.5/json/encoder.py&quot;, line 179, in default</div><div class="line">    raise TypeError(repr(o) + &quot; is not JSON serializable&quot;)</div><div class="line">TypeError: b&apos;5e36be93294a6fea65a4c81571388241b1667fca&apos; is not JSON serializable</div></pre></td></tr></table></figure>
<p>这个错误十分诡异，至今不解，项目运行环境为 <code>Python 3.5.2</code></p>
<p>连首页都进不去，使用的地址为 <code>127.0.0.1:8080</code>，后面尝试把地址修改为 <code>localhost:8080</code> ，就没有这个报错了 Orz</p>
<hr>
<h2 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h2><p><a href="https://medium.com/airbnb-engineering/airflow-a-workflow-management-platform-46318b977fd8" target="_blank" rel="external">Airflow: a workflow management platform</a></p>
<p><a href="https://medium.com/videoamp/what-we-learned-migrating-off-cron-to-airflow-b391841a0da4" target="_blank" rel="external">What we learned migrating off Cron to Airflow</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;有啥用&quot;&gt;&lt;a href=&quot;#有啥用&quot; class=&quot;headerlink&quot; title=&quot;有啥用&quot;&gt;&lt;/a&gt;有啥用&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Airflow&lt;/code&gt; 简单来说就是管理和调度各种离线定时的 Job，用以替代 &lt;code&gt;crontab&lt;/co
    
    </summary>
    
      <category term="技术一路走到黑" scheme="https://amosannn.github.io/categories/%E6%8A%80%E6%9C%AF%E4%B8%80%E8%B7%AF%E8%B5%B0%E5%88%B0%E9%BB%91/"/>
    
    
      <category term="airflow" scheme="https://amosannn.github.io/tags/airflow/"/>
    
  </entry>
  
  <entry>
    <title>Hive 优化之为外部表创建分区</title>
    <link href="https://amosannn.github.io/2018/10/26/add-partition-after-creating-external-table-in-hive/"/>
    <id>https://amosannn.github.io/2018/10/26/add-partition-after-creating-external-table-in-hive/</id>
    <published>2018-10-26T06:18:52.000Z</published>
    <updated>2018-11-26T07:41:28.022Z</updated>
    
    <content type="html"><![CDATA[<p>首先，我们有一个数据量很大的表。其次，对他进行条件查询或其他操作就像看着一只小蜗牛在爬。</p>
<p>是可忍，孰不可忍！</p>
<h2 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01 原理"></a>0x01 原理</h2><p>关于分区为什么能提升查询速度，这就值得你仔细想想了。</p>
<p>既然 <code>hive</code> 基于文件系统，那么我们可以把它类比成很多个桶。</p>
<p>假设现在有 100 个桶，分别存放不同的海鲜，其中 2 个桶里有我们想要的桂花鱼，1 个桶里有阿根廷大红虾，那如何才能在最快的速度找出这 3 个桶？</p>
<p>按照默认的策略，人们会打开盖子一桶一桶找，而如果有 1000、10000 个桶，就会从一个人找演变成一群人一起找。</p>
<p>有没有改进方式呢？有。</p>
<p>有一天老板发现，不对啊，这个事我居然叫那么多人来做，感觉自己额外付出了很多成本，亏钱了。不行！这个事情必须改革！于是他思前想后好几天怎么也也想不到更好的办法，也因此懊恼了许久。直到有一天，老板夫人得了风寒，老板十分心急，替夫人去药铺抓药，当它看见郎中拿着方子在药柜抓药的时候，心中的郁结终于揭开了。拍了拍脑瓜子，大叫了声，对呀！我怎么没想到呢！</p>
<p>于是，从药铺回来后，老板更改了新的存鱼策略。它让员工们把鱼放进桶里的同时，在桶外贴上标签，取鱼的时候只需要远远地扫一眼就能快速定位。</p>
<p><code>hive</code> 也是如此，你可以粗略地将它的存储系统理解为，将一堆文件放在同一个文件夹里，需要的时候在这堆文件里遍历，最后的效果不言而喻。</p>
<p>分区的好处便是，将文件按一定的维度，存进不同的文件夹，相当于给他们打好了标签，这样我按这个维度搜索时，便不需要遍历其他无关的文件。数据越多，对查询效率的提升就越大。</p>
<h2 id="0x02-操作一波"><a href="#0x02-操作一波" class="headerlink" title="0x02 操作一波"></a>0x02 操作一波</h2><p>首先看分区列表，如果结果为空就表示该表下没有分区。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">partitions</span> tmp.tmp_user;</div></pre></td></tr></table></figure>
<p>给当前表添加分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tmp.tmp_user <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">month</span>=<span class="string">'2018_10'</span>, <span class="keyword">day</span>=<span class="string">'25'</span>) location <span class="string">'/user/amos/tmp_user/month=2018_10/day=25'</span>;</div></pre></td></tr></table></figure>
<p>将数据迁移至分区中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hdfs dfs -mv /user/amos/tmp_user/data_20181025.csv /user/amos/tmp_user/month=2018_10/day=25</div></pre></td></tr></table></figure>
<h2 id="物极必反"><a href="#物极必反" class="headerlink" title="物极必反"></a>物极必反</h2><p>为了提升搜索效果，增加分区数是可以的，但是如果分区数太过庞大，而需查询的数据也很多的话，分区带来的提升会被弱化。尤其是在分区中数据较为分散的时候，只要查询数据量达到一定量级便会轻易集中所有分区。</p>
<p>大量分区带来的不良后果不仅如此，还会在查询之后给磁盘带来更多的小文件。</p>
<h2 id="说点题外话"><a href="#说点题外话" class="headerlink" title="说点题外话"></a>说点题外话</h2><p>如果是对数据仓库进行优化</p>
<p>在 <code>hive</code> 中，有几种办法</p>
<ul>
<li>分区</li>
<li>分桶</li>
<li>索引</li>
<li>区分活跃用户</li>
<li>更改数据结构（id - string –&gt; id - list<string>)</string></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;首先，我们有一个数据量很大的表。其次，对他进行条件查询或其他操作就像看着一只小蜗牛在爬。&lt;/p&gt;
&lt;p&gt;是可忍，孰不可忍！&lt;/p&gt;
&lt;h2 id=&quot;0x01-原理&quot;&gt;&lt;a href=&quot;#0x01-原理&quot; class=&quot;headerlink&quot; title=&quot;0x01 原理&quot;&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>axios 添加登录拦截器后出现 preflight response 错误</title>
    <link href="https://amosannn.github.io/2018/04/02/axios-intercepter-perflight-response-error/"/>
    <id>https://amosannn.github.io/2018/04/02/axios-intercepter-perflight-response-error/</id>
    <published>2018-04-02T08:26:26.000Z</published>
    <updated>2018-04-02T17:14:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>为了加强网站安全性，给除了登录注册等特殊页面外的页面路由都加上了访问控制。然后问题就出现了，接口请求没有返回值了！抛了这样一个错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Request header field 8080:1 Authorization is not allowed by Access-Control-Allow-Headers in preflight response</div></pre></td></tr></table></figure>
<p>之前的跨域设置居然不管用了！</p>
<h1 id="挣扎"><a href="#挣扎" class="headerlink" title="挣扎"></a>挣扎</h1><h2 id="分析拦截器代码"><a href="#分析拦截器代码" class="headerlink" title="分析拦截器代码"></a>分析拦截器代码</h2><p>看看这个拦截器代码究竟做了什么！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// http request 拦截器</span></div><div class="line">axios.interceptors.request.use(</div><div class="line">    <span class="function"><span class="params">config</span> =&gt;</span> &#123;</div><div class="line">        <span class="keyword">if</span> (store.state.token) &#123;  <span class="comment">// 判断是否存在token，如果存在的话，则每个http header都加上token</span></div><div class="line">            config.headers.Authorization = <span class="string">`token <span class="subst">$&#123;store.state.token&#125;</span>`</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> config;</div><div class="line">    &#125;,</div><div class="line">    err =&gt; &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line"><span class="comment">// http response 拦截器</span></div><div class="line">axios.interceptors.response.use(</div><div class="line">    <span class="function"><span class="params">response</span> =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">    &#125;,</div><div class="line">    error =&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (error.response) &#123;</div><div class="line">            <span class="keyword">switch</span> (error.response.status) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">401</span>:</div><div class="line">                    <span class="comment">// 返回 401 清除token信息并跳转到登录页面</span></div><div class="line">                    store.commit(types.LOGOUT);</div><div class="line">                    router.replace(&#123;</div><div class="line">                        <span class="attr">path</span>: <span class="string">'login'</span>,</div><div class="line">                        <span class="attr">query</span>: &#123;<span class="attr">redirect</span>: router.currentRoute.fullPath&#125;</div><div class="line">                    &#125;)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error.response.data)   <span class="comment">// 返回接口返回的错误信息</span></div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>嗯！debugger一波找到原因在第五行，添加了一个新的请求头<code>Authorization</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.headers.Authorization = <span class="string">`token <span class="subst">$&#123;store.state.token&#125;</span>`</span>;</div></pre></td></tr></table></figure>
<p>然而，在前端的请求中并没有看到<code>Authorization</code>这个头。。</p>
<h2 id="分析请求"><a href="#分析请求" class="headerlink" title="分析请求"></a>分析请求</h2><p>在查看请求详情的时候发现一条重要信息：</p>
<p><img src="../images/options_request.png" alt="options request"></p>
<p>options请求过后没有请求接口，那么就证明是服务端拒绝了访问。</p>
<blockquote>
<p>跨域资源共享标准新增了一组 HTTP 首部字段，允许服务器声明哪些源站有权限访问哪些资源。另外，规范要求，对那些可能对服务器数据产生副作用的 HTTP 请求方法（特别是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET" target="_blank" rel="external"><code>GET</code></a> 以外的 HTTP 请求，或者搭配某些 MIME 类型的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST" target="_blank" rel="external"><code>POST</code></a> 请求），浏览器必须首先使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS" target="_blank" rel="external"><code>OPTIONS</code></a> 方法发起一个预检请求（preflight request），从而获知服务端是否允许该跨域请求。服务器确认允许之后，才发起实际的 HTTP 请求。在预检请求的返回中，服务器端也可以通知客户端，是否需要携带身份凭证（包括 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies" target="_blank" rel="external">Cookies </a>和 HTTP 认证相关数据）。</p>
<p>— 来自 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">MDN web docs</a></p>
</blockquote>
<h1 id="填坑"><a href="#填坑" class="headerlink" title="填坑"></a>填坑</h1><p>解决的办法也很简单，在服务端的跨域拦截器中给<code>OPTIONS</code>方法放行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 新增一个 Authorization 请求头</span></div><div class="line">response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Origin, X-Requested-With, Content-Type, Accept, Authorization"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 放行 OPTIONS 请求方法</span></div><div class="line"><span class="keyword">if</span> (request.getMethod().equals(<span class="string">"OPTIONS"</span>)) &#123;</div><div class="line">  response.setStatus(HttpServletResponse.SC_OK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务端放行<code>OPTIONS</code>方法后，再次请求，就可以看到同一个请求发送了两次。第一条为 options 方法，第二条请求就是 post 或 get 请求啦，并且在 header 中也可以看到 axios 拦截器设置的 Authorization 了。</p>
<hr>
<p>参考链接</p>
<p><a href="https://github.com/superman66/vue-axios-github" target="_blank" rel="external">axios 登录拦截器</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">Access control CORS</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;为了加强网站安全性，给除了登录注册等特殊页面外的页面路由都加上了访问控制。然后问题就出现了，接口请求没有返回值了！抛了这样一个错误：&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://amosannn.github.io/tags/Vue/"/>
    
      <category term="axios" scheme="https://amosannn.github.io/tags/axios/"/>
    
      <category term="CORS" scheme="https://amosannn.github.io/tags/CORS/"/>
    
  </entry>
  
  <entry>
    <title>Docker + Nginx 镜像部署 Vue 项目</title>
    <link href="https://amosannn.github.io/2018/03/28/deploy-the-vue-project-using-docker-and-nginx/"/>
    <id>https://amosannn.github.io/2018/03/28/deploy-the-vue-project-using-docker-and-nginx/</id>
    <published>2018-03-28T07:23:57.000Z</published>
    <updated>2018-03-28T17:36:14.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简单介绍-Docker"><a href="#简单介绍-Docker" class="headerlink" title="简单介绍 Docker"></a>简单介绍 Docker</h1><p>Docker 真是个好东西，很好的降低了不同环境发版的兼容性问题。无论是 Linux, Windows 或是 Mac OS，再也不用怕系统环境不同，软件版本不同导致的项目无法启动。这些问题只需要自定义 Docker 镜像，并在 Docker 中启动，就能搞定部署啦。</p>
<h1 id="部署-Vue-项目"><a href="#部署-Vue-项目" class="headerlink" title="部署 Vue 项目"></a>部署 Vue 项目</h1><p>传统的部署一般为编译后放在 Nginx 目录下，或者放在 Tomcat 目录下。玩了有一阵子 Docker 了，就试试用 Docker 来部署吧。</p>
<h2 id="本地操作"><a href="#本地操作" class="headerlink" title="本地操作"></a>本地操作</h2><p>首先给本地的vue项目打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm run build</div></pre></td></tr></table></figure>
<p>执行命令之后项目根目录下会出现 dist 文件夹，将其上传至服务器。</p>
<h2 id="服务器操作"><a href="#服务器操作" class="headerlink" title="服务器操作"></a>服务器操作</h2><h3 id="编写-Dockerfile"><a href="#编写-Dockerfile" class="headerlink" title="编写 Dockerfile"></a>编写 Dockerfile</h3><p>新建 Dockerfile</p>
<blockquote>
<p>vi Dockerfile</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#导入nginx镜像</div><div class="line">FROM nginx:1.13.7</div><div class="line">MAINTAINER amosannn &lt;amosannn@gmail.com&gt;</div><div class="line">#把当前打包工程的html复制到虚拟地址</div><div class="line">COPY dist/ /usr/share/nginx/html/</div><div class="line">#使用自定义nginx.conf配置端口和监听</div><div class="line">RUN rm /etc/nginx/conf.d/default.conf</div><div class="line">ADD default.conf /etc/nginx/conf.d/</div><div class="line"></div><div class="line">RUN /bin/bash -c &apos;echo init ok!!!&apos;</div></pre></td></tr></table></figure>
<h3 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h3><p>新建<code>default.conf</code></p>
<blockquote>
<p>vi default.conf</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line"># 项目中定义的端口号</div><div class="line">    listen       8000; </div><div class="line">    server_name  localhost;</div><div class="line"></div><div class="line">    #charset koi8-r;</div><div class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    #error_page  404              /404.html;</div><div class="line"></div><div class="line">    # redirect server error pages to the static page /50x.html</div><div class="line">    #</div><div class="line">    error_page   500 502 503 504  /50x.html;</div><div class="line">    location = /50x.html &#123;</div><div class="line">        root   html;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Docker-打包"><a href="#Docker-打包" class="headerlink" title="Docker 打包"></a>Docker 打包</h3><p>打包前项目目录下应该有这几个文件(夹)：<code>default.conf</code>,<code>dist</code>,<code>Dockerfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t zhiliao:v1 .</div></pre></td></tr></table></figure>
<p>别忘了末尾的小点点</p>
<p>最后出现这两条提示即为打包成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Successfully built 6f656946fde3</div><div class="line">Successfully tagged zhiliao:v1</div></pre></td></tr></table></figure>
<h3 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker images</div></pre></td></tr></table></figure>
<p>如果在结果中看到，则为打包成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">zhiliao             latest              c5d9c47be079        17 minutes ago      111MB</div></pre></td></tr></table></figure>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 80:8000 zhiliao:v1</div></pre></td></tr></table></figure>
<p>命令中的<code>-d</code>意为后台运行</p>
<p>-p 为端口号，前半部分为外网访问的端口，后半部分为 Nginx 反向代理寻找的内部端口</p>
<h3 id="查看运行结果"><a href="#查看运行结果" class="headerlink" title="查看运行结果"></a>查看运行结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker ps</div></pre></td></tr></table></figure>
<p>这条命令等价于<code>docker container ls</code>，加上 -a 则可显示全部</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@VM_108_54_centos zhiliao-vue]# docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES</div><div class="line">bdd5842a4cae        zhiliao:v1          &quot;nginx -g &apos;daemon ...&quot;   42 seconds ago      Exited (1) 41 seconds ago                       frosty_joliot</div></pre></td></tr></table></figure>
<h3 id="查找日志"><a href="#查找日志" class="headerlink" title="查找日志"></a>查找日志</h3><p>如果遇到程序崩溃或者镜像启动失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker logs &apos;CONTAINER ID&apos;</div></pre></td></tr></table></figure>
<p>使用 ps 命令可以找到到 <code>CONTAINER ID</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@VM_108_54_centos zhiliao-vue]# docker logs bdd5842a4cae</div><div class="line">2018/03/28 07:11:51 [emerg] 1#1: unknown directive &quot;//这里使用项目中的端口号&quot; in /etc/nginx/conf.d/default.conf:3</div><div class="line">nginx: [emerg] unknown directive &quot;//这里使用项目中的端口号&quot; in /etc/nginx/conf.d/default.conf:3</div></pre></td></tr></table></figure>
<hr>
<p>参考链接：</p>
<p><a href="https://yeasy.gitbooks.io/docker_practice/content/image/build.html" target="_blank" rel="external">使用 Dockerfile 定制镜像</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;简单介绍-Docker&quot;&gt;&lt;a href=&quot;#简单介绍-Docker&quot; class=&quot;headerlink&quot; title=&quot;简单介绍 Docker&quot;&gt;&lt;/a&gt;简单介绍 Docker&lt;/h1&gt;&lt;p&gt;Docker 真是个好东西，很好的降低了不同环境发版的兼容性问题。无
    
    </summary>
    
    
      <category term="Vue" scheme="https://amosannn.github.io/tags/Vue/"/>
    
      <category term="Docker" scheme="https://amosannn.github.io/tags/Docker/"/>
    
      <category term="Nginx" scheme="https://amosannn.github.io/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>解决Vue前后端分离跨域问题</title>
    <link href="https://amosannn.github.io/2018/03/22/solove-vue-cross-domain-problems/"/>
    <id>https://amosannn.github.io/2018/03/22/solove-vue-cross-domain-problems/</id>
    <published>2018-03-22T01:11:58.000Z</published>
    <updated>2018-03-22T13:17:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>用Vue写了几个页面，发现request传到后端没带上cookies，心想不对劲，Postman明明可以访问啊。再仔细看看，后端已经开放了跨域访问，不需要<code>HttpServletRequest</code>的接口也可以成功请求。一定就是前端请求缺少请求头或是某些参数了。上网查了一下还真是这样，又跳过了一个坑，很开心啦～</p>
<h1 id="前后端跨域设置"><a href="#前后端跨域设置" class="headerlink" title="前后端跨域设置"></a>前后端跨域设置</h1><h2 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h2><blockquote>
<p>main.js 设置</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></div><div class="line"></div><div class="line">axios.defaults.withCredentials=<span class="literal">true</span>;</div><div class="line">Vue.prototype.$http = axios;</div></pre></td></tr></table></figure>
<blockquote>
<p>请求需带上withCredentials</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">getData() &#123;</div><div class="line">        <span class="keyword">this</span>.$axios.get(<span class="string">'http://127.0.0.1:8080/xxx/xxxxx'</span>,&#123;</div><div class="line">          <span class="attr">headers</span>: &#123;</div><div class="line">            <span class="string">"Content-Type"</span>:<span class="string">"application/json;charset=utf-8"</span></div><div class="line">          &#125;,</div><div class="line">          <span class="attr">withCredentials</span> : <span class="literal">true</span></div><div class="line">        &#125;).then( <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</div><div class="line">          <span class="keyword">if</span>( response.data.code === <span class="string">'0000'</span>)&#123;</div><div class="line">            <span class="keyword">this</span>.items = response.data.data.xxx;</div><div class="line">            <span class="built_in">console</span>.log(<span class="keyword">this</span>.items)</div><div class="line">          &#125;</div><div class="line">        &#125;)</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<h2 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h2><p>加上一个跨域用Interceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></div><div class="line">      Object handler) <span class="keyword">throws</span> Exception &#123;</div><div class="line">    response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</div><div class="line">    response.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"*"</span>);</div><div class="line">    response.setHeader(<span class="string">"Access-Control-Max-Age"</span>, <span class="string">"3600"</span>);</div><div class="line">    response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Origin, X-Requested-With, Content-Type, Accept"</span>);</div><div class="line">    response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>,<span class="string">"true"</span>); <span class="comment">//是否允许浏览器携带用户身份信息（cookie）</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</div></pre></td></tr></table></figure>
<p>请求源地址如果写了<code>*</code>很可能会被拒绝访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed to load http://127.0.0.1:8080/zhiliao/login: Response to preflight request doesn&apos;t pass access control check: The value of the &apos;Access-Control-Allow-Origin&apos; header in the response must not be the wildcard &apos;*&apos; when the request&apos;s credentials mode is &apos;include&apos;. Origin &apos;http://127.0.0.1:8000&apos; is therefore not allowed access. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute.</div></pre></td></tr></table></figure>
<p>如果出现这样的报错，那就得指定地址啦！    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;http://127.0.0.1:8000&quot;);</div></pre></td></tr></table></figure>
<p>这里依旧有个小坑：指定地址为<code>http://127.0.0.1:8000</code>的时候前端页面若是<code>localhost</code>是无法访问的。</p>
<h1 id="看看axios官方文档"><a href="#看看axios官方文档" class="headerlink" title="看看axios官方文档"></a>看看axios官方文档</h1><p><a href="https://github.com/axios/axios#request-config" target="_blank" rel="external">axios官方配置说明</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// `timeout` specifies the number of milliseconds before the request times out.</div><div class="line">// If the request takes longer than `timeout`, the request will be aborted.</div><div class="line">timeout: 1000,</div><div class="line"></div><div class="line">// `withCredentials` indicates whether or not cross-site Access-Control requests</div><div class="line">// should be made using credentials</div><div class="line">withCredentials: false, // default</div><div class="line"></div><div class="line">// `adapter` allows custom handling of requests which makes testing easier.</div><div class="line">// Return a promise and supply a valid response (see lib/adapters/README.md).</div><div class="line">adapter: function (config) &#123;</div><div class="line">  /* ... */</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>配置文件中<code>withCredentials</code>默认是关闭的，手动修改配置文件或在项目中重定义即可。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;用Vue写了几个页面，发现request传到后端没带上cookies，心想不对劲，Postman明明可以访问啊。再仔细看看，后端已经开放了跨
    
    </summary>
    
    
      <category term="Vue" scheme="https://amosannn.github.io/tags/Vue/"/>
    
      <category term="CORS" scheme="https://amosannn.github.io/tags/CORS/"/>
    
      <category term="SpringBoot" scheme="https://amosannn.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>什么是分布式事务</title>
    <link href="https://amosannn.github.io/2018/03/19/simple-to-understand-transaction/"/>
    <id>https://amosannn.github.io/2018/03/19/simple-to-understand-transaction/</id>
    <published>2018-03-19T09:27:21.000Z</published>
    <updated>2018-03-19T18:46:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简单说一下事务"><a href="#简单说一下事务" class="headerlink" title="简单说一下事务"></a>简单说一下事务</h1><p>事务就是单个逻辑执行的一系列操作，要么全部成功，要么全部失败。<br>事务包含4个特性（<strong>ACID</strong>）：</p>
<ol>
<li>Atomicity（原子性）：事务中包含的所有操作要么全做，要么全不做。</li>
<li>Consistency（一致性）：事务开始以前，数据库处于一致性的状态，事务结束后，数据库也必须处于一致性的状态。</li>
<li>Isolation（隔离性）：系统必须保证事务不受其他并发执行的事务的影响。</li>
<li>Durability（持久性）：一个事务一旦成功完成，它对数据库的改变必须是永久的，即使是在系统遇到故障的情况下也不会丢失。</li>
</ol>
<h1 id="假如没有事务"><a href="#假如没有事务" class="headerlink" title="假如没有事务"></a>假如没有事务</h1><p>我们以银行的ATM机为例子：</p>
<p>取款操作一般为两个核心步骤：</p>
<ol>
<li>余额扣除相应金额</li>
<li>ATM机吐钞</li>
</ol>
<p>如果金额扣除了，而ATM机却因某些原因无法吐钞，那用户就崩溃了。而若是金额没扣除，ATM却吐钞了，那就是银行崩溃了。所以事务（分布式）的重要性在这里就体现的淋漓尽致了，这也正是事务中的一致性。</p>
<h1 id="说说分布式事务"><a href="#说说分布式事务" class="headerlink" title="说说分布式事务"></a>说说分布式事务</h1><p>分布式事务的体现有很多种，其中最具代表性的是由Oracle Tuxedo系统提出的XA分布式事务协议。</p>
<p>XA协议包含<strong>两阶段提交（2PC）</strong>和<strong>三阶段提交（3PC</strong>两种实现。</p>
<h2 id="两阶段提交（2PC）"><a href="#两阶段提交（2PC）" class="headerlink" title="两阶段提交（2PC）"></a>两阶段提交（2PC）</h2><p>两阶段提交就像支持多人游戏的网游游戏模式（可参考近日火热的PUBG）。</p>
<p>在游戏开始前，一个队伍中会有两种角色，队长与队员，也分别对应着<strong>事务协调者</strong>与<strong>事务参与者</strong>。</p>
<h3 id="正向流程"><a href="#正向流程" class="headerlink" title="正向流程"></a>正向流程</h3><p>一个XA两阶段提交的正向流程分为这两阶段：</p>
<blockquote>
<p>第一阶段：</p>
</blockquote>
<ol>
<li>以发送邀请的玩家A为首，邀请到了呵自己开黑的小伙伴B、C、D进入队伍，并请求他们点击准备按钮。</li>
<li>小伙伴 B、C、D 全部准备就绪。</li>
</ol>
<blockquote>
<p>第二阶段：</p>
</blockquote>
<ol>
<li>A 大吼一声，「伞兵一号准备就绪！」随即点击开始游戏。</li>
<li>A 首先进入游戏，等待 B、C、D片刻后，大家都成功进入游戏地图。</li>
</ol>
<p>对应到正经的XA中是这样的：</p>
<blockquote>
<p>第一阶段：</p>
</blockquote>
<ol>
<li><p>协调者向参与者们发送Prepare请求</p>
</li>
<li><p>参与者们各自执行自己与事务有关的数据更新，写入Undo Log和Redo Log。如果参与者执行成功，暂时不提交事务，而是向事务协调节点返回“Done”消息。</p>
<p>当事务协调者接到了所有参与者的返回消息，整个分布式事务将会进入第二阶段。</p>
</li>
</ol>
<blockquote>
<p>第二阶段：</p>
</blockquote>
<ol>
<li>如果事务协调节点在之前所收到都是正向返回，那么它将会向所有事务参与者发出Commit请求。</li>
<li>接到Commit请求之后，事务参与者节点会各自进行本地的事务提交，并释放锁资源。当本地事务完成提交后，将会向事务协调者返回“ACK”消息。</li>
<li>事务协调者接收到所有事务参与者的“完成”反馈，整个分布式事务完成。</li>
</ol>
<h3 id="失败处理"><a href="#失败处理" class="headerlink" title="失败处理"></a>失败处理</h3><ol>
<li>如果某个事务参与者反馈失败消息，说明该节点的本地事务执行不成功，必须回滚。</li>
<li>于是在第二阶段，事务协调节点向所有的事务参与者发送Abort请求。接收到Abort请求之后，各个事务参与者节点需要在本地进行事务的回滚操作，回滚操作依照Undo Log来进行。</li>
</ol>
<h2 id="XA两阶段提交的不足"><a href="#XA两阶段提交的不足" class="headerlink" title="XA两阶段提交的不足"></a>XA两阶段提交的不足</h2><blockquote>
<p>性能问题</p>
</blockquote>
<p>XA协议遵循强一致性。在事务执行过程中，各个节点占用着数据库资源，只有当所有节点准备完毕，事务协调者才会通知提交，参与者提交后释放资源。这样的过程有着非常明显的性能问题。</p>
<blockquote>
<p>协调者单点故障问题</p>
</blockquote>
<p>事务协调者是整个XA模型的核心，一旦事务协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务。</p>
<blockquote>
<p>丢失消息导致的不一致问题</p>
</blockquote>
<p>在XA协议的第二个阶段，如果发生局部网络问题，一部分事务参与者收到了提交消息，另一部分事务参与者没收到提交消息，那么就导致了节点之间数据的不一致。</p>
<h3 id="如何避免XA两阶段提交的种种问题"><a href="#如何避免XA两阶段提交的种种问题" class="headerlink" title="如何避免XA两阶段提交的种种问题"></a>如何避免XA两阶段提交的种种问题</h3><p>有许多其他的分布式事务方案可供选择：</p>
<blockquote>
<p>XA三阶段提交</p>
</blockquote>
<p>XA三阶段提交在两阶段提交的基础上增加了CanCommit阶段，并且引入了超时机制。一旦事物参与者迟迟没有接到协调者的commit请求，会自动进行本地commit。这样有效解决了协调者单点故障的问题。但是性能问题和不一致的问题仍然没有根本解决。</p>
<blockquote>
<p>MQ事务</p>
</blockquote>
<p>利用消息中间件来异步完成事务的后一半更新，实现系统的最终一致性。这个方式避免了像XA协议那样的性能问题。</p>
<blockquote>
<p>TCC事务</p>
</blockquote>
<p>TCC事务是Try、Commit、Cancel三种指令的缩写，其逻辑模式类似于XA两阶段提交，但是实现方式是在代码层面来人为实现。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;简单说一下事务&quot;&gt;&lt;a href=&quot;#简单说一下事务&quot; class=&quot;headerlink&quot; title=&quot;简单说一下事务&quot;&gt;&lt;/a&gt;简单说一下事务&lt;/h1&gt;&lt;p&gt;事务就是单个逻辑执行的一系列操作，要么全部成功，要么全部失败。&lt;br&gt;事务包含4个特性（&lt;stron
    
    </summary>
    
    
      <category term="Transaction" scheme="https://amosannn.github.io/tags/Transaction/"/>
    
      <category term="SQL" scheme="https://amosannn.github.io/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>MyBatis一对一映射注解@One的使用及理解</title>
    <link href="https://amosannn.github.io/2018/03/08/the-use-and-understanding-of-one-annotated-by-mybatis/"/>
    <id>https://amosannn.github.io/2018/03/08/the-use-and-understanding-of-one-annotated-by-mybatis/</id>
    <published>2018-03-08T12:32:21.000Z</published>
    <updated>2018-03-08T23:35:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本着更深入地使用注解来开发，慢慢地发现脱离了XML的MyBatis好多好多的坑。我觉得很大的原因还是来自于官方文档的不完善，以及使用注解开发持久层的人并不多见，导致网络上的相关讨论过于贫瘠并重复化，毕竟对于复杂查询的支持，我认为还没有在XML里写一条SQL方便呢～  </p>
<p>所以这篇文章用于补充一语带过的官方文档，记录下自己趟过的坑。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="一对一映射"><a href="#一对一映射" class="headerlink" title="一对一映射"></a>一对一映射</h2><p>注解化一对一映射其实就是将XML中的<code>ResultType</code>属性对应的实体写在<code>@Results</code>注解中。其中的<code>@Result</code>填入实体的属性，而若该属性为实体中的实体，则需要@One注解引入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Select</span>(<span class="string">"select answer_id, answer_content, liked_count, create_time, question_id, user_id from answer where create_time &gt; #&#123;createTime&#125; order by liked_count desc, create_time desc limit 0,10"</span>)</div><div class="line"><span class="meta">@Results</span>(&#123;</div><div class="line">    <span class="meta">@Result</span>(id = <span class="keyword">true</span>, column = <span class="string">"answer_id"</span>, property = <span class="string">"answerId"</span>, javaType = Integer.class),</div><div class="line">    <span class="meta">@Result</span>(column = <span class="string">"answer_content"</span>, property = <span class="string">"answerContent"</span>),</div><div class="line">    <span class="meta">@Result</span>(column = <span class="string">"liked_count"</span>, property = <span class="string">"likedCount"</span>, javaType = Integer.class, jdbcType = JdbcType.INTEGER),</div><div class="line">    <span class="meta">@Result</span>(column = <span class="string">"create_time"</span>, property = <span class="string">"createTime"</span>),</div><div class="line">    <span class="meta">@Result</span>(column = <span class="string">"question_id"</span>, property = <span class="string">"question"</span>, javaType = Question.class,</div><div class="line">        one = <span class="meta">@One</span>(select = <span class="string">"selectQuestionById"</span>)),</div><div class="line">    <span class="meta">@Result</span>(column = <span class="string">"user_id"</span>, property = <span class="string">"user"</span>,</div><div class="line">        one = <span class="meta">@One</span>(select = <span class="string">"selectUserById"</span>))</div><div class="line">&#125;)</div><div class="line"><span class="function">List&lt;Answer&gt; <span class="title">listAnswerByCreateTime</span><span class="params">(@Param(<span class="string">"createTime"</span>)</span> <span class="keyword">long</span> createTime)</span>;</div></pre></td></tr></table></figure>
<p>值得注意的是，映射中的<code>property</code>属性的值不可和其他实体属性一样，应该填写所返回的实体名称。</p>
<p>例如下面代码，我返回的实体为<code>Answer</code>类下的<code>Question</code>类，则<code>property</code>中不可写<code>questionId</code>，而得写<code>question</code>。同时@One中select属性对应的方法若在不同类，则需要写出完整的包名（com.xxx.xxx.getxxxByxx）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Result</span>(column = <span class="string">"question_id"</span>, property = <span class="string">"question"</span>, javaType = Question.class,</div><div class="line">        one = <span class="meta">@One</span>(select = <span class="string">"selectQuestionById"</span>))</div></pre></td></tr></table></figure>
<p>需要注意的是，从@One传递过来的查询条件也需要在主查询语句中查询出来，也就是上面的<code>listAnswerByCreateTime</code>方法需要查询出question_id和user_id，千万别漏了。否则报你错哦！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Select</span>(<span class="string">"select question_id, question_title from question where question_id = #&#123;questionId&#125;"</span>)</div><div class="line"><span class="meta">@ResultType</span>(Question.class)</div><div class="line"><span class="function">Question <span class="title">selectQuestionById</span><span class="params">(@Param(<span class="string">"questionId"</span>)</span> Integer questionId)</span>;</div><div class="line"></div><div class="line"><span class="meta">@Select</span>(<span class="string">"select user_id, username, avatar_url, simple_desc from user where user_id = #&#123;userId&#125;"</span>)</div><div class="line"><span class="meta">@ResultType</span>(User.class)</div><div class="line"><span class="function">User <span class="title">selectUserById</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> Integer userId)</span>;</div></pre></td></tr></table></figure>
<p>由此查询得出的结果集为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">"answerList": [</div><div class="line">            &#123;</div><div class="line">                "answerId": 42,</div><div class="line">                "answerContent": "这是回答！",</div><div class="line">                "likedCount": 3,</div><div class="line">                "createTime": 1520508016650,</div><div class="line">                "userId": null,</div><div class="line">                "questionId": null,</div><div class="line">                "likeState": null,</div><div class="line">                "commentCount": null,</div><div class="line">                "question": &#123;</div><div class="line">                    "questionId": 1,</div><div class="line">                    "questionTitle": "Spring，Django，Rails，Express这些框架技术的出现都是为了解决什么问题，现在这些框架都应用在哪些方面？",</div><div class="line">                    "createTime": null,</div><div class="line">                    "userId": null,</div><div class="line">                    "user": null</div><div class="line">                &#125;,</div><div class="line">                "user": &#123;</div><div class="line">                    "userId": 11218,</div><div class="line">                    "weiboUserId": null,</div><div class="line">                    "email": null,</div><div class="line">                    "username": "amosamos",</div><div class="line">                    "password": null,</div><div class="line">                    "joinTime": null,</div><div class="line">                    "avatarUrl": "https://avatars3.githubusercontent.com/u/16012509?s=400&amp;u=6fe0dd08943216aeff2d3c9d1b8c3e602f6de8e9&amp;v=4"</div><div class="line">                &#125;,</div><div class="line">                "answerCommentList": null</div><div class="line">            &#125;</div><div class="line">        ]</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;本着更深入地使用注解来开发，慢慢地发现脱离了XML的MyBatis好多好多的坑。我觉得很大的原因还是来自于官方文档的不完善，以及使用注解开发
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://amosannn.github.io/tags/SpringBoot/"/>
    
      <category term="MyBatis" scheme="https://amosannn.github.io/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>在SelectProvider注解中使用复杂类型参数（List）</title>
    <link href="https://amosannn.github.io/2018/03/03/SelectProvider-use-List-parameter/"/>
    <id>https://amosannn.github.io/2018/03/03/SelectProvider-use-List-parameter/</id>
    <published>2018-03-03T15:50:39.000Z</published>
    <updated>2018-03-04T00:39:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近开发中尝试使用注解来代替xml完成Mybatis的sql编写，实现更完(装)整(逼)的无xml编程。结果没写多久就跌进大坑了Orz</p>
<p>总所周知的是Mybatis支持的注解中有@Select、@Insert、@Update、@Delete这四个基本操作。使用这些注解你可以非常快的完成基础操作，如果想执行一些复杂操作，例如包含where、foreach等xml中一个标签即可完成的操作，便需要用到另一个注解 –&gt; @SelectProvider</p>
<p>如果你的需求只是传递一些基础类型，那你学习使用SelectProvider的曲线还是很平滑的。如果你的需求是传递一些复杂类型，例如List，那就可能会尴尬了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Mapper</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QuestionMapper</span> </span>&#123;</div><div class="line">  <span class="meta">@SelectProvider</span>(type = QuestionSqlProvider.class, method = <span class="string">"listQuestionByQuestionId"</span>)</div><div class="line">  <span class="function">List&lt;Question&gt; <span class="title">listQuestionByQuestionId</span><span class="params">(@Param(<span class="string">"idList"</span>)</span> List&lt;Integer&gt; idList)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一开始我理所当然的把List<integer>作为输入参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">listQuestionByQuestionId</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; idList)</span> </span>&#123;</div><div class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">    sb.append(<span class="string">"("</span>);</div><div class="line">    <span class="keyword">for</span> (Integer questionId : idList) &#123;</div><div class="line">      sb.append(<span class="string">" '"</span> + questionId + <span class="string">"',"</span>);</div><div class="line">    &#125;</div><div class="line">    sb.deleteCharAt(sb.length() - <span class="number">1</span>);</div><div class="line">    sb.append(<span class="string">")"</span>);</div><div class="line">    System.out.println(sb.toString());</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SQL() &#123;&#123;</div><div class="line">      SELECT(<span class="string">" question_id,question_title,create_time "</span>);</div><div class="line">      FROM(<span class="string">" question "</span>);</div><div class="line">      WHERE(<span class="string">" question_id in "</span> + sb.toString());</div><div class="line">    &#125;&#125;.toString();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></integer></p>
<p>燃鹅。。jvm很无情的抛了个错误出来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">00:29:39.814 [http-nio-8080-exec-1] DEBUG o.s.web.servlet.DispatcherServlet - Could not complete request</div><div class="line">org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.builder.BuilderException: Error invoking SqlProvider method (com.amosannn.mapper.QuestionSqlProvider.listQuestionByQuestionId).  Cause: org.apache.ibatis.binding.BindingException: Parameter &apos;arg0&apos; not found. Available parameters are [idList, param1]</div></pre></td></tr></table></figure></p>
<p>很难受，Mybatis的官方文档里并没有针对@SelectProvider有更多的demo，翻遍了各大门户网站也没见到有相关的讨论。兜兜转转依旧没有眉目，想到多参数的传递会被Mybatis自动封装进Map，该不会List也是同样被封装进Map吧。结果一试还真是这样。。</p>
<p>终于摸索出问题的关键，只需把形参由List<integer>类型替换为Map类型就能接收到前面传来的List了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuestionSqlProvider</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">listQuestionByQuestionId</span><span class="params">(<span class="keyword">final</span> Map&lt;String, Object&gt; map)</span> </span>&#123;</div><div class="line">    List&lt;Integer&gt; idList = (List&lt;Integer&gt;)map.get(<span class="string">"idList"</span>);</div><div class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">    sb.append(<span class="string">"("</span>);</div><div class="line">    <span class="keyword">for</span> (Integer questionId : idList) &#123;</div><div class="line">      sb.append(<span class="string">" '"</span> + questionId + <span class="string">"',"</span>);</div><div class="line">    &#125;</div><div class="line">    sb.deleteCharAt(sb.length() - <span class="number">1</span>);</div><div class="line">    sb.append(<span class="string">")"</span>);</div><div class="line">    System.out.println(sb.toString());</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SQL() &#123;&#123;</div><div class="line">      SELECT(<span class="string">" question_id,question_title,create_time "</span>);</div><div class="line">      FROM(<span class="string">" question "</span>);</div><div class="line">      WHERE(<span class="string">" question_id in "</span> + sb.toString());</div><div class="line">    &#125;&#125;.toString();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></integer></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近开发中尝试使用注解来代替xml完成Mybatis的sql编写，实现更完(装)整(逼)的无xml编程。结果没写多久就跌进大坑了Orz&lt;/p&gt;
&lt;p&gt;总所周知的是Mybatis支持的注解中有@Select、@Insert、@Update、@Delete这四个基本操作。使用这
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://amosannn.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>JedisPool报错：Could not return the resource to the pool</title>
    <link href="https://amosannn.github.io/2018/01/30/jedispool-could-not-return-resource-error/"/>
    <id>https://amosannn.github.io/2018/01/30/jedispool-could-not-return-resource-error/</id>
    <published>2018-01-30T07:08:45.000Z</published>
    <updated>2018-01-30T15:58:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Bug的起源和解法"><a href="#Bug的起源和解法" class="headerlink" title="Bug的起源和解法"></a>Bug的起源和解法</h1><p>这个错误来的实在猝不及防，第一次请求可以成功使用<code>JedisPool</code>，而第二次请求便会报错，在翻遍了所有相关博客后一度以为是自己的配置出了错，于是不断修改配置文件中的redis连接池参数。<br>折腾老半天之后，没有帮助TAT<br>这时，我想起10年前的某个午后，蝉鸣的空气中传来的几分安定，出神地趴在窗边看麻雀扑腾的我，被一声厉呵带回现实。之后便到了标准环节–”下课到办公室找我”。之后的事情便记不太清了，只是我深深地记得当时的心境，想不出的问题换个角度想，一定会有不同的发现。<br>那就回归报错吧，“无法将资源返回到池”，再回想到我的jedisPool对象，旷的一声，仿佛天旋地转一般，一切的一切突然都变透彻了。</p>
<h2 id="错误根源及出错原因"><a href="#错误根源及出错原因" class="headerlink" title="错误根源及出错原因"></a>错误根源及出错原因</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">followUser</span><span class="params">(Integer localUserId, Integer userId)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> (Jedis jedis = jedisPool.getResource()) &#123;</div><div class="line">    jedis.zadd(localUserId + RedisKey.FOLLOW_USER, System.currentTimeMillis(),</div><div class="line">        String.valueOf(userId));</div><div class="line">    jedis.zadd(userId + RedisKey.FOLLOWED_USER, System.currentTimeMillis(),</div><div class="line">        String.valueOf(localUserId));</div><div class="line">  &#125; <span class="keyword">catch</span> (JedisException e) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line">  jedisPool.close();<span class="comment">// 问题就出在这里</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JedisPool在configuration类中初始化（项目启动时有spring自动扫描）<br>然而在每个业务类调用完之后就被手动关闭，自然执行完第一次后就不再能取出resource的，也无法return。<br>解决这个bug只需把每个service实现类中的<code>jedisPool.close()</code>删去即可。</p>
<h2 id="为什么会出现这种写法"><a href="#为什么会出现这种写法" class="headerlink" title="为什么会出现这种写法"></a>为什么会出现这种写法</h2><p>说到这个就不得不提起Jedis的wiki<br>官方po出的demo是这样使用jedis的：  </p>
<h3 id="首先引入pom"><a href="#首先引入pom" class="headerlink" title="首先引入pom"></a>首先引入pom</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;redis.clients&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;jedis&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;2.9.0&lt;/version&gt;</div><div class="line">    &lt;type&gt;jar&lt;/type&gt;</div><div class="line">    &lt;scope&gt;compile&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h3 id="然后实例化JedisPool"><a href="#然后实例化JedisPool" class="headerlink" title="然后实例化JedisPool"></a>然后实例化JedisPool</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JedisPool pool = <span class="keyword">new</span> JedisPool(<span class="keyword">new</span> JedisPoolConfig(), <span class="string">"localhost"</span>);</div></pre></td></tr></table></figure>
<h3 id="接着实例化jedis有两种方法"><a href="#接着实例化jedis有两种方法" class="headerlink" title="接着实例化jedis有两种方法"></a>接着实例化jedis有两种方法</h3><ol>
<li><p>try-with-resource法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Jedis implements Closeable. Hence, the jedis instance will be auto-closed after the last statement.</span></div><div class="line"><span class="keyword">try</span> (Jedis jedis = pool.getResource()) &#123;</div><div class="line">  <span class="comment">/// ... do stuff here ... for example</span></div><div class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</div><div class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</div><div class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>); </div><div class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">/// ... when closing your application:</span></div><div class="line">pool.close();<span class="comment">// 这便是原罪</span></div></pre></td></tr></table></figure>
</li>
<li><p>手动关闭jedis法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Jedis jedis = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  jedis = pool.getResource();</div><div class="line">  <span class="comment">/// ... do stuff here ... for example</span></div><div class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</div><div class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</div><div class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>); </div><div class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">  <span class="comment">// You have to close jedis object. If you don't close then</span></div><div class="line">  <span class="comment">// it doesn't release back to pool and you can't get a new</span></div><div class="line">  <span class="comment">// resource from pool.</span></div><div class="line">  <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</div><div class="line">    jedis.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/// ... when closing your application:</span></div><div class="line">pool.close();</div></pre></td></tr></table></figure>
</li>
</ol>
<p>虽然不在报错了，但是现在不关的话又不知道在哪能关的了它了。。。</p>
<hr>
<p>双手奉上： <a href="https://github.com/xetorthio/jedis/wiki/Getting-started" target="_blank" rel="external">Jedis官方指引</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Bug的起源和解法&quot;&gt;&lt;a href=&quot;#Bug的起源和解法&quot; class=&quot;headerlink&quot; title=&quot;Bug的起源和解法&quot;&gt;&lt;/a&gt;Bug的起源和解法&lt;/h1&gt;&lt;p&gt;这个错误来的实在猝不及防，第一次请求可以成功使用&lt;code&gt;JedisPool&lt;/c
    
    </summary>
    
    
      <category term="java" scheme="https://amosannn.github.io/tags/java/"/>
    
      <category term="jedis" scheme="https://amosannn.github.io/tags/jedis/"/>
    
      <category term="redis" scheme="https://amosannn.github.io/tags/redis/"/>
    
  </entry>
  
</feed>
